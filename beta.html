<!DOCTYPE html>
<html lang="th" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sunday Call - โทรด้วยเสียง</title>
    <link rel="icon" href="https://img2.pic.in.th/pic/sunday-TV.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        .sky-background { background: linear-gradient(170deg, #0f172a 0%, #1e293b 60%, #334155 100%); }
        .glass-panel { background: rgba(30, 41, 59, 0.25); -webkit-backdrop-filter: blur(12px); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 1.5rem; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3); }
        .glass-input { background: rgba(51, 65, 85, 0.4); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 0.75rem; transition: all 0.2s ease; }
        .glass-input:focus { background: rgba(71, 85, 105, 0.6); border-color: rgba(99, 102, 241, 0.8); box-shadow: none; outline: none; }
        .btn-primary { background-color: #4f46e5; color: white; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-primary:disabled { background-color: #3730a3; cursor: not-allowed; }
        .btn-secondary { background-color: #334155; color: white; transition: background-color 0.2s; }
        .btn-secondary:hover { background-color: #475569; }
        .btn-success { background-color: #16a34a; color: white; transition: background-color 0.2s; }
        .btn-success:hover { background-color: #15803d; }
        .btn-danger { background-color: #dc2626; color: white; transition: background-color 0.2s; }
        .btn-danger:hover { background-color: #b91c1c; }
        .tab-btn { background: transparent; color: #9ca3af; padding: 0.5rem 1rem; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .tab-btn.active { color: #f0b90b; border-bottom-color: #f0b90b; }
        .list-item { background-color: rgba(51, 65, 85, 0.3); transition: background-color 0.2s; }
        .list-item:hover { background-color: rgba(51, 65, 85, 0.6); }
        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltiptext { visibility: hidden; width: 140px; background-color: #1f2937; color: #fff; text-align: center; border-radius: 6px; padding: 5px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -70px; opacity: 0; transition: opacity 0.3s; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden dark sky-background flex items-center justify-center p-4">

    <!-- Main Application UI -->
    <main class="w-full max-w-4xl h-full max-h-[90vh] grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Left Panel: Calling -->
        <div class="md:col-span-1 glass-panel p-6 flex flex-col space-y-6">
            <div class="text-center">
                <h2 class="text-xl font-bold text-white">ID ของคุณ</h2>
                <div class="mt-2 flex items-center justify-center gap-2 p-3 rounded-lg bg-slate-900/50">
                    <span id="my-peer-id" class="text-yellow-400 font-mono text-sm truncate">กำลังเชื่อมต่อ...</span>
                    <button id="copy-id-btn" class="p-2 rounded-md hover:bg-slate-600 transition tooltip">
                        <i class="bi bi-clipboard text-white"></i>
                        <span class="tooltiptext">คัดลอก ID</span>
                    </button>
                </div>
            </div>
            <div class="flex-grow flex flex-col space-y-4">
                <h2 class="text-xl font-bold text-white text-center">โทรหา</h2>
                <div>
                    <label for="recipient-id-input" class="text-gray-300 mb-1 block">กรอก ID ของผู้รับ</label>
                    <input type="text" id="recipient-id-input" class="w-full p-3 glass-input text-gray-200" placeholder="ID ของเพื่อน">
                </div>
                <button id="call-btn" class="w-full py-3 rounded-lg btn-primary font-bold text-lg flex items-center justify-center gap-2" disabled>
                    <i class="bi bi-telephone-outbound-fill"></i>
                    <span>โทร</span>
                </button>
            </div>
             <div class="text-center text-xs text-gray-400">
                <p>สถานะ: <span id="connection-status" class="font-semibold text-gray-300">กำลังเริ่มต้น...</span></p>
            </div>
        </div>

        <!-- Right Panel: Tabs for Contacts & History -->
        <div class="md:col-span-2 glass-panel p-6 flex flex-col">
            <div class="flex border-b border-slate-600 mb-4">
                <button id="contacts-tab-btn" class="tab-btn active">รายชื่อ</button>
                <button id="history-tab-btn" class="tab-btn">ประวัติการโทร</button>
            </div>
            <div id="contacts-view" class="flex-grow overflow-y-auto space-y-3 pr-2">
                <!-- Contacts will be rendered here -->
            </div>
            <div id="history-view" class="hidden flex-grow overflow-y-auto space-y-3 pr-2">
                <!-- Call history will be rendered here -->
            </div>
        </div>
    </main>

    <!-- Modals -->
    <!-- Incoming Call Modal -->
    <div id="incoming-call-modal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 fade-in">
        <div class="glass-panel p-8 rounded-2xl text-center w-full max-w-sm">
            <h2 class="text-2xl font-bold text-white">สายเรียกเข้า</h2>
            <p class="text-yellow-400 mt-2 text-lg" id="caller-id-display">จาก: ...</p>
            <div class="mt-8 flex justify-center gap-6">
                <button id="accept-call-btn" class="w-20 h-20 rounded-full btn-success flex items-center justify-center"><i class="bi bi-telephone-inbound-fill text-3xl"></i></button>
                <button id="reject-call-btn" class="w-20 h-20 rounded-full btn-danger flex items-center justify-center"><i class="bi bi-telephone-x-fill text-3xl"></i></button>
            </div>
        </div>
    </div>

    <!-- Calling Modal -->
    <div id="calling-modal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 fade-in">
        <div class="glass-panel p-8 rounded-2xl text-center w-full max-w-sm">
            <h2 class="text-2xl font-bold text-white">กำลังโทรหา...</h2>
            <p class="text-yellow-400 mt-2 text-lg" id="calling-id-display">...</p>
            <div class="mt-8">
                <button id="cancel-call-btn" class="w-20 h-20 rounded-full btn-danger flex items-center justify-center mx-auto"><i class="bi bi-telephone-x-fill text-3xl"></i></button>
            </div>
        </div>
    </div>
    
    <!-- In-Call UI -->
    <div id="in-call-ui" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 fade-in">
        <div class="glass-panel p-8 rounded-2xl text-center w-full max-w-sm">
            <h2 class="text-2xl font-bold text-white">กำลังคุยกับ</h2>
            <p class="text-yellow-400 mt-2 text-lg" id="in-call-with-display">...</p>
            <p class="text-gray-300 mt-2" id="call-timer">00:00</p>
            <div class="mt-8 flex justify-center gap-6">
                <button id="mute-btn" class="w-20 h-20 rounded-full btn-secondary flex items-center justify-center"><i id="mute-icon" class="bi bi-mic-fill text-3xl"></i></button>
                <button id="hang-up-btn" class="w-20 h-20 rounded-full btn-danger flex items-center justify-center"><i class="bi bi-telephone-fill text-3xl"></i></button>
            </div>
        </div>
    </div>

    <!-- Add Contact Modal -->
    <div id="add-contact-modal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 fade-in">
        <div class="glass-panel p-8 rounded-2xl w-full max-w-sm">
            <h2 class="text-2xl font-bold text-white mb-4">เพิ่มรายชื่อ</h2>
            <p class="text-gray-300 mb-2">ID: <span id="add-contact-id" class="font-mono text-yellow-400"></span></p>
            <div>
                <label for="add-contact-name" class="text-gray-300 mb-1 block">ชื่อเล่น</label>
                <input type="text" id="add-contact-name" class="w-full p-3 glass-input text-gray-200" placeholder="ชื่อที่ต้องการบันทึก">
            </div>
            <div class="mt-6 flex gap-4">
                <button id="save-contact-btn" class="flex-1 py-2 rounded-lg btn-primary font-bold">บันทึก</button>
                <button id="cancel-add-contact-btn" class="flex-1 py-2 rounded-lg btn-secondary font-bold">ยกเลิก</button>
            </div>
        </div>
    </div>

    <!-- Audio elements for sound effects -->
    <audio id="remote-audio" autoplay></audio>

    <script type="module">
        // --- STATE MANAGEMENT ---
        const state = {
            peer: null,
            myId: null,
            localStream: null,
            dataConnection: null,
            mediaConnection: null,
            contacts: [],
            history: [],
            callTimerInterval: null,
            isMuted: false,
            currentCallDirection: null, // FIX: Track call direction
        };

        // --- UI ELEMENTS ---
        const ui = {
            myPeerId: document.getElementById('my-peer-id'),
            copyIdBtn: document.getElementById('copy-id-btn'),
            recipientIdInput: document.getElementById('recipient-id-input'),
            callBtn: document.getElementById('call-btn'),
            connectionStatus: document.getElementById('connection-status'),
            contactsTabBtn: document.getElementById('contacts-tab-btn'),
            historyTabBtn: document.getElementById('history-tab-btn'),
            contactsView: document.getElementById('contacts-view'),
            historyView: document.getElementById('history-view'),
            incomingCallModal: document.getElementById('incoming-call-modal'),
            callerIdDisplay: document.getElementById('caller-id-display'),
            acceptCallBtn: document.getElementById('accept-call-btn'),
            rejectCallBtn: document.getElementById('reject-call-btn'),
            callingModal: document.getElementById('calling-modal'),
            callingIdDisplay: document.getElementById('calling-id-display'),
            cancelCallBtn: document.getElementById('cancel-call-btn'),
            inCallUi: document.getElementById('in-call-ui'),
            inCallWithDisplay: document.getElementById('in-call-with-display'),
            callTimer: document.getElementById('call-timer'),
            muteBtn: document.getElementById('mute-btn'),
            muteIcon: document.getElementById('mute-icon'),
            hangUpBtn: document.getElementById('hang-up-btn'),
            addContactModal: document.getElementById('add-contact-modal'),
            addContactId: document.getElementById('add-contact-id'),
            addContactName: document.getElementById('add-contact-name'),
            saveContactBtn: document.getElementById('save-contact-btn'),
            cancelAddContactBtn: document.getElementById('cancel-add-contact-btn'),
            remoteAudio: document.getElementById('remote-audio'),
        };

        // --- SOUND SYNTHESIS (Tone.js) ---
        // FIX: Delay sound initialization until after a user gesture.
        let sounds = {};
        let isAudioInitialized = false;

        async function initializeAudio() {
            if (isAudioInitialized || typeof Tone === 'undefined') {
                return;
            }
            try {
                await Tone.start();
                console.log("AudioContext started successfully.");
                
                sounds = {
                    ringtone: new Tone.Synth({
                        oscillator: { type: 'sine' },
                        envelope: { attack: 0.01, decay: 0.1, sustain: 0.5, release: 0.1 }
                    }).toDestination(),
                    dialTone: new Tone.Synth({
                        oscillator: { type: 'pulse', width: 0.8 },
                        envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.1 }
                    }).toDestination(),
                    endCallTone: new Tone.Synth({
                        oscillator: { type: 'triangle' },
                        envelope: { attack: 0.01, decay: 0.5, sustain: 0, release: 0.1 }
                    }).toDestination(),
                    ringtoneLoop: null
                };
                isAudioInitialized = true;
            } catch (e) {
                console.error("Could not start AudioContext:", e);
                alert("ไม่สามารถเริ่มระบบเสียงได้ กรุณาคลิกที่หน้าจออีกครั้ง");
            }
        }
        
        function playRingtone() {
            if (!isAudioInitialized) {
                console.warn("Cannot play ringtone, audio context not started.");
                return;
            }
            sounds.ringtoneLoop = new Tone.Loop(time => {
                sounds.ringtone.triggerAttackRelease('G5', '8n', time);
                sounds.ringtone.triggerAttackRelease('E5', '8n', time + 0.2);
            }, '0.5s').start(0);
            Tone.Transport.start();
        }

        function stopRingtone() {
            if (sounds.ringtoneLoop) {
                sounds.ringtoneLoop.stop(0);
                sounds.ringtoneLoop.dispose();
                sounds.ringtoneLoop = null;
                if (Tone.Transport.state === 'started') {
                    Tone.Transport.stop();
                }
            }
        }

        // --- UTILITY & PERSISTENCE (Cookies) ---
        const setCookie = (name, value, days = 365) => {
            const expires = new Date(Date.now() + days * 864e5).toUTCString();
            document.cookie = name + '=' + encodeURIComponent(JSON.stringify(value)) + '; expires=' + expires + '; path=/; SameSite=Lax';
        };
        const getCookie = (name) => {
            try {
                const value = document.cookie.split('; ').find(row => row.startsWith(name + '='))?.split('=')[1];
                return value ? JSON.parse(decodeURIComponent(value)) : null;
            } catch (e) {
                console.error("Failed to parse cookie:", name, e);
                return null;
            }
        };

        const saveContacts = () => setCookie('sunday_call_contacts', state.contacts);
        const loadContacts = () => { state.contacts = getCookie('sunday_call_contacts') || []; renderContacts(); };
        const saveHistory = () => setCookie('sunday_call_history', state.history);
        const loadHistory = () => { state.history = getCookie('sunday_call_history') || []; renderHistory(); };
        
        const findContactName = (id) => state.contacts.find(c => c.id === id)?.name || id;

        // --- UI RENDERING ---
        function renderContacts() {
            ui.contactsView.innerHTML = '';
            if (state.contacts.length === 0) {
                ui.contactsView.innerHTML = `<p class="text-gray-400 text-center mt-4">ไม่มีรายชื่อที่บันทึกไว้</p>`;
                return;
            }
            state.contacts.forEach(contact => {
                const contactEl = document.createElement('div');
                contactEl.className = 'list-item p-3 rounded-lg flex items-center justify-between';
                contactEl.innerHTML = `
                    <div>
                        <p class="font-bold text-white">${contact.name}</p>
                        <p class="text-xs text-gray-400 font-mono">${contact.id}</p>
                    </div>
                    <div class="flex gap-2">
                        <button class="call-contact-btn p-2 rounded-md hover:bg-green-600 transition" data-id="${contact.id}"><i class="bi bi-telephone-fill"></i></button>
                        <button class="remove-contact-btn p-2 rounded-md hover:bg-red-600 transition" data-id="${contact.id}"><i class="bi bi-trash-fill"></i></button>
                    </div>
                `;
                ui.contactsView.appendChild(contactEl);
            });
        }

        function renderHistory() {
            ui.historyView.innerHTML = '';
            if (state.history.length === 0) {
                ui.historyView.innerHTML = `<p class="text-gray-400 text-center mt-4">ไม่มีประวัติการโทร</p>`;
                return;
            }
            [...state.history].reverse().forEach(entry => {
                const name = findContactName(entry.id);
                const icon = {
                    outgoing: 'bi-telephone-outbound-fill text-blue-400',
                    incoming: 'bi-telephone-inbound-fill text-green-400',
                    missed: 'bi-telephone-x-fill text-red-400'
                }[entry.type];

                const historyEl = document.createElement('div');
                historyEl.className = 'list-item p-3 rounded-lg flex items-center justify-between';
                historyEl.innerHTML = `
                    <div class="flex items-center gap-4">
                        <i class="bi ${icon} text-xl"></i>
                        <div>
                            <p class="font-bold text-white">${name}</p>
                            <p class="text-xs text-gray-400">${new Date(entry.timestamp).toLocaleString('th-TH')}</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        ${entry.id !== 'N/A' ? `<button class="call-back-btn p-2 rounded-md hover:bg-green-600 transition" data-id="${entry.id}"><i class="bi bi-telephone-fill"></i></button>` : ''}
                        ${!state.contacts.some(c => c.id === entry.id) && entry.id !== 'N/A' ? `<button class="add-contact-from-history-btn p-2 rounded-md hover:bg-blue-600 transition" data-id="${entry.id}"><i class="bi bi-person-plus-fill"></i></button>` : ''}
                    </div>
                `;
                ui.historyView.appendChild(historyEl);
            });
        }
        
        function addCallToHistory(type, id) {
            state.history.push({ type, id, timestamp: Date.now() });
            if (state.history.length > 50) state.history.shift(); // Limit history size
            saveHistory();
            renderHistory();
        }

        // --- CORE CALLING LOGIC ---
        function initializePeer() {
            state.peer = new Peer();

            state.peer.on('open', id => {
                console.log('PeerJS connection open. My ID is:', id);
                state.myId = id;
                ui.myPeerId.textContent = id;
                ui.connectionStatus.textContent = 'ออนไลน์';
                ui.connectionStatus.classList.remove('text-red-400');
                ui.connectionStatus.classList.add('text-green-400');
                ui.callBtn.disabled = false;
            });

            state.peer.on('connection', (conn) => {
                console.log('Incoming data connection from', conn.peer);
                state.dataConnection = conn;
                ui.callerIdDisplay.textContent = findContactName(conn.peer);
                ui.incomingCallModal.classList.remove('hidden');
                playRingtone();
            });

            state.peer.on('call', (call) => {
                console.log('Incoming media call from', call.peer);
                state.mediaConnection = call;
                navigator.mediaDevices.getUserMedia({ video: false, audio: true })
                    .then(stream => {
                        state.localStream = stream;
                        call.answer(stream);
                        call.on('stream', remoteStream => {
                            ui.remoteAudio.srcObject = remoteStream;
                        });
                        showInCallUI(call.peer);
                    }).catch(err => console.error('Failed to get local stream', err));
            });
            
            state.peer.on('error', err => {
                console.error('PeerJS Error:', err);
                ui.connectionStatus.textContent = `ข้อผิดพลาด: ${err.type}`;
                ui.connectionStatus.classList.remove('text-green-400');
                ui.connectionStatus.classList.add('text-red-400');
            });
        }
        
        async function makeCall(recipientId) {
            await initializeAudio();
            if (!isAudioInitialized) {
                alert("ระบบเสียงยังไม่พร้อม กรุณาคลิกที่หน้าจอแล้วลองอีกครั้ง");
                return;
            }
            if (!recipientId || recipientId === state.myId) {
                alert('กรุณาใส่ ID ที่ถูกต้อง');
                return;
            }
            
            sounds.dialTone.triggerAttackRelease('C5', '0.2');
            state.currentCallDirection = 'outgoing'; // FIX: Set call direction
            ui.callingIdDisplay.textContent = findContactName(recipientId);
            ui.callingModal.classList.remove('hidden');

            const conn = state.peer.connect(recipientId);
            state.dataConnection = conn;
            
            conn.on('open', () => {
                console.log('Data connection established with', recipientId);
                conn.on('data', (data) => handleData(data, recipientId));
            });
        }

        function handleData(data, peerId) {
            console.log('Received data:', data);
            switch (data.type) {
                case 'call_accepted':
                    ui.callingModal.classList.add('hidden');
                    navigator.mediaDevices.getUserMedia({ video: false, audio: true })
                        .then(stream => {
                            state.localStream = stream;
                            const call = state.peer.call(peerId, stream);
                            state.mediaConnection = call;
                            call.on('stream', remoteStream => {
                                ui.remoteAudio.srcObject = remoteStream;
                            });
                            showInCallUI(peerId);
                        }).catch(err => console.error('Failed to get local stream', err));
                    break;
                case 'call_rejected':
                    alert(`${findContactName(peerId)} ปฏิเสธสาย`);
                    addCallToHistory('outgoing', peerId);
                    cleanUpCall();
                    break;
                case 'hang_up':
                    addCallToHistory(state.currentCallDirection === 'outgoing' ? 'outgoing' : 'incoming', peerId);
                    cleanUpCall();
                    break;
            }
        }
        
        function showInCallUI(peerId) {
            ui.incomingCallModal.classList.add('hidden');
            ui.callingModal.classList.add('hidden');
            ui.inCallUi.classList.remove('hidden');
            ui.inCallWithDisplay.textContent = findContactName(peerId);
            
            let seconds = 0;
            ui.callTimer.textContent = '00:00';
            state.callTimerInterval = setInterval(() => {
                seconds++;
                const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
                const secs = (seconds % 60).toString().padStart(2, '0');
                ui.callTimer.textContent = `${mins}:${secs}`;
            }, 1000);
        }

        function cleanUpCall() {
            stopRingtone();
            if (state.dataConnection) state.dataConnection.close();
            if (state.mediaConnection) state.mediaConnection.close();
            if (state.localStream) state.localStream.getTracks().forEach(track => track.stop());
            if (state.callTimerInterval) clearInterval(state.callTimerInterval);
            
            state.dataConnection = null;
            state.mediaConnection = null;
            state.localStream = null;
            state.isMuted = false;
            state.currentCallDirection = null; // FIX: Reset call direction
            
            ui.muteIcon.classList.remove('bi-mic-mute-fill');
            ui.muteIcon.classList.add('bi-mic-fill');
            ui.incomingCallModal.classList.add('hidden');
            ui.callingModal.classList.add('hidden');
            ui.inCallUi.classList.add('hidden');
            ui.callTimer.textContent = '00:00';
        }

        // --- EVENT HANDLERS ---
        ui.copyIdBtn.addEventListener('click', () => {
            if(!state.myId) return;
            navigator.clipboard.writeText(state.myId);
            const tooltip = ui.copyIdBtn.querySelector('.tooltiptext');
            tooltip.textContent = 'คัดลอกแล้ว!';
            setTimeout(() => { tooltip.textContent = 'คัดลอก ID'; }, 2000);
        });

        ui.callBtn.addEventListener('click', () => makeCall(ui.recipientIdInput.value.trim()));

        ui.acceptCallBtn.addEventListener('click', () => {
            stopRingtone();
            state.currentCallDirection = 'incoming'; // FIX: Set call direction
            state.dataConnection.send({ type: 'call_accepted' });
            state.dataConnection.on('data', (data) => handleData(data, state.dataConnection.peer));
            addCallToHistory('incoming', state.dataConnection.peer);
        });
        
        ui.rejectCallBtn.addEventListener('click', () => {
            stopRingtone();
            state.dataConnection.send({ type: 'call_rejected' });
            addCallToHistory('missed', state.dataConnection.peer);
            cleanUpCall();
        });

        ui.cancelCallBtn.addEventListener('click', () => {
            addCallToHistory('outgoing', state.dataConnection.peer);
            cleanUpCall();
        });

        ui.hangUpBtn.addEventListener('click', async () => {
            await initializeAudio();
            if(isAudioInitialized) sounds.endCallTone.triggerAttackRelease('A4', '0.5');
            if (state.dataConnection) {
                state.dataConnection.send({ type: 'hang_up' });
                // FIX: Use stored direction for accurate history
                addCallToHistory(state.currentCallDirection, state.dataConnection.peer);
            }
            setTimeout(cleanUpCall, 100);
        });

        ui.muteBtn.addEventListener('click', () => {
            if (!state.localStream) return;
            state.isMuted = !state.isMuted;
            state.localStream.getAudioTracks()[0].enabled = !state.isMuted;
            ui.muteIcon.classList.toggle('bi-mic-fill', !state.isMuted);
            ui.muteIcon.classList.toggle('bi-mic-mute-fill', state.isMuted);
        });

        ui.contactsTabBtn.addEventListener('click', () => {
            ui.contactsTabBtn.classList.add('active');
            ui.historyTabBtn.classList.remove('active');
            ui.contactsView.classList.remove('hidden');
            ui.historyView.classList.add('hidden');
        });

        ui.historyTabBtn.addEventListener('click', () => {
            ui.historyTabBtn.classList.add('active');
            ui.contactsTabBtn.classList.remove('active');
            ui.historyView.classList.remove('hidden');
            ui.contactsView.classList.add('hidden');
        });
        
        // Event delegation for dynamic lists
        ui.contactsView.addEventListener('click', e => {
            const callBtn = e.target.closest('.call-contact-btn');
            const removeBtn = e.target.closest('.remove-contact-btn');
            if (callBtn) makeCall(callBtn.dataset.id);
            if (removeBtn) {
                if (confirm(`คุณต้องการลบ "${findContactName(removeBtn.dataset.id)}" ใช่หรือไม่?`)) {
                    state.contacts = state.contacts.filter(c => c.id !== removeBtn.dataset.id);
                    saveContacts();
                    renderContacts();
                }
            }
        });
        
        ui.historyView.addEventListener('click', e => {
            const callBackBtn = e.target.closest('.call-back-btn');
            const addContactBtn = e.target.closest('.add-contact-from-history-btn');
            if (callBackBtn) makeCall(callBackBtn.dataset.id);
            if (addContactBtn) {
                ui.addContactId.textContent = addContactBtn.dataset.id;
                ui.addContactName.value = '';
                ui.addContactModal.classList.remove('hidden');
            }
        });

        ui.saveContactBtn.addEventListener('click', () => {
            const id = ui.addContactId.textContent;
            const name = ui.addContactName.value.trim();
            if (name) {
                // Check if contact already exists, if so, update it.
                const existingContact = state.contacts.find(c => c.id === id);
                if (existingContact) {
                    existingContact.name = name;
                } else {
                    state.contacts.push({ id, name });
                }
                saveContacts();
                renderContacts();
                renderHistory();
                ui.addContactModal.classList.add('hidden');
            }
        });
        
        ui.cancelAddContactBtn.addEventListener('click', () => {
            ui.addContactModal.classList.add('hidden');
        });

        // --- INITIALIZATION ---
        // FIX: Add a one-time event listener to initialize audio on the first user interaction.
        document.body.addEventListener('click', initializeAudio, { once: true });

        window.onload = () => {
            loadContacts();
            loadHistory();
            initializePeer();
        };

    </script>
</body>
</html>
