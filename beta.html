<!DOCTYPE html>
<html lang="th" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sunday TV</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        .sky-background { background: linear-gradient(170deg, #0f172a 0%, #1e293b 60%, #334155 100%); }
        .glass-panel { background: rgba(30, 41, 59, 0.25); -webkit-backdrop-filter: blur(12px); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 1.5rem; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3); }
        .glass-input { background: rgba(51, 65, 85, 0.4); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 0.75rem; transition: all 0.2s ease; }
        .glass-input:focus { background: rgba(71, 85, 105, 0.6); border-color: rgba(99, 102, 241, 0.8); box-shadow: none; outline: none; }
        .custom-selector-panel { position: absolute; z-index: 50; top: 100%; left: 0; right: 0; margin-top: 0.5rem; animation: fadeIn 0.3s ease-out; }
        #remote-video, #local-video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #remote-video { background-color: #111; }
        .video-container { display: flex; width: 100%; height: 100%; }
        .video-wrapper { position: relative; overflow: hidden; background-color: #111; }
        .nickname-overlay { position: absolute; bottom: 1rem; left: 1rem; background: rgba(0,0,0,0.5); padding: 0.25rem 0.75rem; border-radius: 0.5rem; font-size: 0.875rem; color: white; }
        @media (orientation: portrait) { .video-container { flex-direction: column; } .video-wrapper { width: 100%; height: 50%; } }
        @media (orientation: landscape) { .video-container { flex-direction: row; } .video-wrapper { width: 50%; height: 100%; } }
        #floating-chat-container { background: rgba(17, 24, 39, 0.75); border-top: 1px solid rgba(255, 255, 255, 0.1); border-right: 1px solid rgba(255, 255, 255, 0.1); border-top-right-radius: 1.5rem; }
        .chat-message.faded-out { opacity: 0; transform: translateY(-10px); }
        .themed-btn { border-radius: 50%; display: flex; align-items: center; justify-content: center; background-color: #FFC107; box-shadow: 0 4px 10px rgba(0,0,0,0.2), inset 0 -4px 6px rgba(0,0,0,0.1); transition: all 0.2s ease-in-out; }
        .themed-btn:hover { transform: scale(1.1); background-color: #FFD54F; }
        .sun-loader { width: 80px; height: 80px; position: relative; animation: spin 10s linear infinite; }
        .sun-loader .sun-body { width: 50px; height: 50px; background-color: #FFC107; border-radius: 50%; position: absolute; top: 15px; left: 15px; }
        .sun-loader .sun-ray { background-color: #FFC107; width: 6px; height: 18px; border-radius: 3px; position: absolute; top: -3px; left: 37px; }
        .sun-ray:nth-child(2) { transform: rotate(45deg); top: 8px; left: 58px; } .sun-ray:nth-child(3) { transform: rotate(90deg); top: 31px; left: 65px; } .sun-ray:nth-child(4) { transform: rotate(135deg); top: 54px; left: 58px; } .sun-ray:nth-child(5) { transform: rotate(180deg); top: 67px; left: 37px; } .sun-ray:nth-child(6) { transform: rotate(225deg); top: 54px; left: 16px; } .sun-ray:nth-child(7) { transform: rotate(270deg); top: 31px; left: 9px; } .sun-ray:nth-child(8) { transform: rotate(315deg); top: 8px; left: 16px; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden dark">

    <!-- Page 1: Profile Setup Modal -->
    <div id="profile-modal" class="hidden sky-background fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="glass-panel p-8 w-full max-w-md text-center">
            <h2 class="text-3xl font-bold text-white mb-2">สร้างโปรไฟล์ของคุณ</h2>
            <p class="text-gray-400 mb-8">ข้อมูลนี้จะแสดงให้เพื่อนของคุณเห็น</p>
            <div class="space-y-4 text-left">
                <div> <label for="nickname-input" class="block mb-1 text-sm font-medium text-gray-300">ชื่อเล่น</label> <input type="text" id="nickname-input" class="w-full p-3 glass-input text-gray-200 focus:ring-0" placeholder="ใส่ชื่อเล่นของคุณ"> </div>
                <div> <label for="age-input" class="block mb-1 text-sm font-medium text-gray-300">อายุ</label> <input type="number" id="age-input" class="w-full p-3 glass-input text-gray-200 focus:ring-0" placeholder="เช่น 25"> </div>
                <div> <label for="gender-select" class="block mb-1 text-sm font-medium text-gray-300">เพศ</label> <select id="gender-select" class="w-full p-3 glass-input text-gray-200 focus:ring-0"> <option>ชาย</option> <option>หญิง</option> <option>LGBTQ</option> <option>สาวหล่อ</option> <option>เกย์</option> <option>กำหนดเอง</option> <option>ไม่ระบุ</option> </select> </div>
                <div id="custom-gender-container" class="hidden space-y-4">
                    <div> <label for="custom-gender-name-input" class="block mb-1 text-sm font-medium text-gray-300">ระบุเพศของคุณ</label> <input type="text" id="custom-gender-name-input" class="w-full p-3 glass-input text-gray-200 focus:ring-0" placeholder="เช่น Non-binary"> </div>
                    <div> <label for="custom-gender-emoji-input" class="block mb-1 text-sm font-medium text-gray-300">อิโมจิประจำตัว</label> <input type="text" id="custom-gender-emoji-input" class="w-full p-3 glass-input text-gray-200 focus:ring-0" placeholder="ใส่ 1 อิโมจิ" maxlength="2"> </div>
                </div>
            </div>
            <button id="save-profile-btn" class="w-full mt-8 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-xl text-lg transition-all duration-200 active:scale-95 shadow-md">บันทึกและถัดไป</button>
        </div>
    </div>
    
    <!-- Page 2: Country Setup -->
    <div id="country-setup-view" class="sky-background w-full h-full flex-col items-center justify-center p-4 sm:p-6 relative overflow-hidden hidden">
        <div class="glass-panel p-8 w-full max-w-lg text-center fade-in">
             <h2 class="text-3xl font-bold text-white mb-2">ตั้งค่าการค้นหา</h2>
             <p class="text-gray-400 mb-8">เลือกประเทศเพื่อการจับคู่ที่ดียิ่งขึ้น</p>
             <div class="w-full grid grid-cols-1 md:grid-cols-2 gap-6">
                <div id="my-country-selector" class="relative">
                    <label class="block mb-1 text-sm font-medium text-gray-300">ประเทศของคุณ</label>
                    <button type="button" class="selector-btn w-full p-3 glass-input text-gray-200 flex items-center justify-between"></button>
                </div>
                <div id="partner-country-selector" class="relative">
                    <label class="block mb-1 text-sm font-medium text-gray-300">ค้นหาเพื่อนจาก</label>
                    <button type="button" class="selector-btn w-full p-3 glass-input text-gray-200 flex items-center justify-between"></button>
                </div>
            </div>
            <button id="save-countries-btn" class="w-full mt-8 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-xl text-lg transition-all duration-200 active:scale-95 shadow-md">บันทึกและไปที่ล็อบบี้</button>
        </div>
    </div>

    <!-- Page 3: Lobby / Start View -->
    <div id="settings-view" class="sky-background w-full h-full flex flex-col p-4 sm:p-6 relative overflow-hidden hidden">
        <header class="w-full max-w-7xl mx-auto flex justify-between items-center p-4 glass-panel mb-6">
            <img src="https://img2.pic.in.th/pic/sunday-TV.png" alt="Sunday TV Logo" class="h-10 w-auto" onerror="this.style.display='none'">
            <div class="flex items-center gap-4">
                <button id="edit-profile-btn" class="flex items-center gap-2 text-gray-300 hover:text-white transition-colors"><i class="bi bi-person-fill text-xl"></i> แก้ไขโปรไฟล์</button>
                <button id="edit-countries-btn" class="flex items-center gap-2 text-gray-300 hover:text-white transition-colors"><i class="bi bi-globe-americas text-xl"></i> ตั้งค่าประเทศ</button>
            </div>
        </header>
        <main class="w-full max-w-7xl mx-auto flex-grow grid grid-cols-1 lg:grid-cols-3 gap-6 overflow-hidden">
            <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6 overflow-hidden">
                <div class="glass-panel p-6 flex flex-col">
                    <h2 class="text-2xl font-bold text-gray-200 mb-4 text-center flex-shrink-0">ออนไลน์ทั้งหมด</h2>
                    <div id="online-users-list" class="flex-grow overflow-y-auto pr-2 space-y-3"></div>
                </div>
                <div class="glass-panel p-6 flex flex-col">
                    <h2 class="text-2xl font-bold text-gray-200 mb-4 text-center flex-shrink-0">กำลังคุยกันอยู่</h2>
                    <div id="paired-users-list" class="flex-grow overflow-y-auto pr-2 space-y-3"></div>
                </div>
            </div>
            <div class="lg:col-span-1 glass-panel p-8 flex flex-col items-center justify-center">
                 <h2 class="text-2xl font-bold text-gray-200 mb-4 text-center">พร้อมรึยัง?</h2>
                 <p class="text-gray-400 mb-8 text-center">กดปุ่มเพื่อเริ่มค้นหาเพื่อนใหม่ได้เลย!</p>
                 <button id="start-btn" class="w-48 h-48 bg-yellow-400 hover:bg-yellow-500 rounded-full flex flex-col items-center justify-center text-gray-800 font-bold text-2xl transition-transform duration-200 active:scale-95 shadow-lg" disabled>
                    <i class="bi bi-play-fill text-7xl"></i>
                    เริ่มค้นหา
                </button>
                <div id="user-id-display" class="mt-4 text-xs text-gray-400 text-center"></div>
            </div>
        </main>
    </div>

    <!-- Loading View, Chat View, Alert Modal... -->
    <div id="loading-view" class="hidden sky-background w-full h-full flex-col items-center justify-center text-center p-6">...</div>
    <div id="chat-view" class="hidden w-full h-full bg-black relative">...</div>
    <div id="alert-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">...</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, query, where, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAyLE1l-eiPPW-fJIvL2uULmDWXcKRhoEM",
            authDomain: "sunday-tv-videocall.firebaseapp.com",
            projectId: "sunday-tv-videocall",
            storageBucket: "sunday-tv-videocall.firebasestorage.app",
            messagingSenderId: "456379728267",
            appId: "1:456379728267:web:815ef8f00b815e42172f8e",
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let localStream, currentCall, currentDataConnection, peer, userId;
        let searchTimeout, heartbeatInterval;
        let allCountries = [];
        let onlineUsers = new Map();
        let settings = { nickname: '', age: '', gender: '', myCountry: 'TH', partnerCountry: 'worldwide', customGenderName: '', customGenderEmoji: '' };
        let selectorUpdaters = {};

        const presenceCollection = collection(db, `artifacts/${firebaseConfig.appId}/public/data/presence`);

        const ui = {
            profileModal: document.getElementById('profile-modal'), nicknameInput: document.getElementById('nickname-input'),
            ageInput: document.getElementById('age-input'), genderSelect: document.getElementById('gender-select'),
            customGenderContainer: document.getElementById('custom-gender-container'),
            customGenderNameInput: document.getElementById('custom-gender-name-input'),
            customGenderEmojiInput: document.getElementById('custom-gender-emoji-input'),
            saveProfileBtn: document.getElementById('save-profile-btn'),
            countrySetupView: document.getElementById('country-setup-view'),
            saveCountriesBtn: document.getElementById('save-countries-btn'),
            settingsView: document.getElementById('settings-view'), loadingView: document.getElementById('loading-view'),
            chatView: document.getElementById('chat-view'), startBtn: document.getElementById('start-btn'),
            editProfileBtn: document.getElementById('edit-profile-btn'),
            editCountriesBtn: document.getElementById('edit-countries-btn'),
            cancelSearchBtn: document.getElementById('cancel-search-btn'),
            stopBtn: document.getElementById('stop-btn'), nextBtn: document.getElementById('next-btn'),
            localVideo: document.getElementById('local-video'), remoteVideo: document.getElementById('remote-video'),
            userIdDisplay: document.getElementById('user-id-display'), alertModal: document.getElementById('alert-modal'),
            alertModalMessage: document.getElementById('alert-modal-message'), alertModalClose: document.getElementById('alert-modal-close'),
            onlineUsersList: document.getElementById('online-users-list'),
            pairedUsersList: document.getElementById('paired-users-list'),
            myNicknameDisplay: document.getElementById('my-nickname-display'),
            partnerNicknameDisplay: document.getElementById('partner-nickname-display'),
            chatPanel: {
                messages: document.getElementById('messages'), input: document.getElementById('chat-input'),
                sendBtn: document.getElementById('send-btn'), partnerInfo: document.getElementById('partner-info'),
            },
            fullscreenBtn: document.getElementById('fullscreen-btn'),
            fullscreenIcon: document.getElementById('fullscreen-icon'),
        };
        
        const setCookie = (name, value) => { document.cookie = `${name}=${encodeURIComponent(value || "")}; path=/; max-age=31536000; SameSite=Lax`; };
        const getCookie = (name) => { const v = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)'); return v ? decodeURIComponent(v[2]) : null; };
        const showAlert = (message) => { /* ... */ };
        
        const genderEmojiMap = {
            'ชาย': '🧒🏻', 'หญิง': '🧑🏻', 'LGBTQ': '💃🏻',
            'สาวหล่อ': '🧑🏻‍🚀', 'เกย์': '🧑🏻‍⚕️', 'ไม่ระบุ': '🌻'
        };
        const getGenderEmoji = (gender, customEmoji) => {
            if (gender === 'กำหนดเอง' && customEmoji) return customEmoji;
            return genderEmojiMap[gender] || '🤔';
        };

        function showView(viewId) { /* ... */ }
        function createCustomSelector(containerId, options) { /* ... */ }
        document.addEventListener('click', (e) => { /* ... */ });
        async function loadCountries() { /* ... */ }
        
        const updatePresence = async (status, peerId = null, talkingTo = null) => {
            if (!userId) return;
            const data = { status, last_seen: serverTimestamp(), ...settings };
            if (peerId) data.peerId = peerId;
            data.talkingTo = talkingTo;
            await setDoc(doc(presenceCollection, userId), data, { merge: true });
        };
        
        const listenForOnlineUsers = () => { /* ... */ };
        
        const displayOnlineUsers = () => {
             const onlineList = Array.from(onlineUsers.entries())
                .filter(([id, data]) => id !== userId && data.status !== 'busy');
            
            if (onlineList.length === 0) {
                ui.onlineUsersList.innerHTML = `<div class="text-center text-gray-400 p-4"><p>ไม่มีใครออนไลน์อยู่</p></div>`;
                return;
            }
            ui.onlineUsersList.innerHTML = onlineList.map(([id, user]) => {
                const flag = getFlagEmoji(user.country);
                const genderEmoji = getGenderEmoji(user.gender, user.customGenderEmoji);
                const genderText = user.gender === 'กำหนดเอง' ? user.customGenderName : user.gender;
                return `<div class="flex items-center p-3 rounded-lg bg-slate-800/50">
                    <span class="text-3xl mr-2">${genderEmoji}</span>
                    <span class="text-3xl mr-4">${flag}</span>
                    <div>
                        <p class="font-bold text-white">${user.nickname || 'Anonymous'}</p>
                        <p class="text-xs text-gray-400">เพศ ${genderText}, อายุ ${user.age}</p>
                    </div>
                    <span class="ml-auto w-3 h-3 bg-green-400 rounded-full animate-pulse"></span>
                </div>`;
            }).join('');
        };

        const displayPairedUsers = () => {
            const pairedList = [];
            const processed = new Set();
            onlineUsers.forEach((userA, idA) => {
                if (userA.status === 'busy' && userA.talkingTo && !processed.has(idA)) {
                    const userB = onlineUsers.get(userA.talkingTo);
                    if (userB && userB.talkingTo === idA) {
                        pairedList.push({userA, userB});
                        processed.add(idA);
                        processed.add(userA.talkingTo);
                    }
                }
            });

            if (pairedList.length === 0) {
                ui.pairedUsersList.innerHTML = `<div class="text-center text-gray-400 p-4"><p>ยังไม่มีใครคุยกัน</p></div>`;
                return;
            }

            ui.pairedUsersList.innerHTML = pairedList.map(({userA, userB}) => {
                return `<div class="flex items-center justify-center p-3 rounded-lg bg-slate-800/50 gap-2">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">${getGenderEmoji(userA.gender, userA.customGenderEmoji)}</span>
                        <span class="text-white text-sm">${userA.nickname || '...'}</span>
                    </div>
                    <i class="bi bi-heart-fill text-red-500 text-xl"></i>
                    <div class="flex items-center gap-2">
                         <span class="text-white text-sm">${userB.nickname || '...'}</span>
                         <span class="text-2xl">${getGenderEmoji(userB.gender, userB.customGenderEmoji)}</span>
                    </div>
                </div>`;
            }).join('');
        };

        const hangUp = async (findNext = false) => { /* ... */ };
        
        const handleDataConnection = (conn) => {
            conn.on('open', () => {
                conn.send({ type: 'profile', payload: settings });
            });
            conn.on('data', (data) => {
                if (data.type === 'profile') {
                    const { nickname, age, gender, customGenderName, customGenderEmoji, country } = data.payload;
                    const countryName = allCountries.find(c => c.alpha2 === country)?.name || country;
                    const genderText = gender === 'กำหนดเอง' ? customGenderName : gender;
                    ui.chatPanel.partnerInfo.textContent = `คุยกับ: เพศ ${genderText}, อายุ ${age}, จาก ${countryName}`;
                    ui.partnerNicknameDisplay.textContent = nickname || 'คู่สนทนา';
                } else if (data.type === 'chat') {
                    appendMessage(data.payload, 'partner');
                }
            });
            currentDataConnection = conn;
        };

        // ... (All other core functions) ...

        const loadAllSettingsFromCookies = () => {
            settings.nickname = getCookie('userNickname');
            settings.age = getCookie('userAge');
            settings.gender = getCookie('userGender');
            settings.customGenderName = getCookie('userCustomGenderName');
            settings.customGenderEmoji = getCookie('userCustomGenderEmoji');
            settings.myCountry = getCookie('myCountry') || 'TH';
            settings.partnerCountry = getCookie('partnerCountry') || 'worldwide';
        };

        const checkProfile = () => {
            if (!settings.nickname || !settings.age || !settings.gender) {
                showView('profile-modal');
            } else {
                ui.myNicknameDisplay.textContent = settings.nickname;
                loadCountries().then(() => {
                   showView('settings-view'); 
                });
            }
        };

        ui.genderSelect.addEventListener('change', () => {
            if (ui.genderSelect.value === 'กำหนดเอง') {
                ui.customGenderContainer.classList.remove('hidden');
            } else {
                ui.customGenderContainer.classList.add('hidden');
            }
        });

        ui.saveProfileBtn.addEventListener('click', () => {
            const nickname = ui.nicknameInput.value.trim();
            const age = ui.ageInput.value;
            let gender = ui.genderSelect.value;
            let customGenderName = '';
            let customGenderEmoji = '';

            if (!nickname) { showAlert('กรุณาใส่ชื่อเล่น'); return; }
            if (!age || isNaN(age) || age < 13) { showAlert('กรุณาใส่อายุที่ถูกต้อง (13 ปีขึ้นไป)'); return; }

            if (gender === 'กำหนดเอง') {
                customGenderName = ui.customGenderNameInput.value.trim();
                customGenderEmoji = ui.customGenderEmojiInput.value.trim();
                if (!customGenderName) { showAlert('กรุณาระบุชื่อเพศของคุณ'); return; }
                if (!customGenderEmoji) { showAlert('กรุณาใส่อิโมจิประจำตัว'); return; }
            }
            
            settings = { ...settings, nickname, age, gender, customGenderName, customGenderEmoji };
            setCookie('userNickname', nickname);
            setCookie('userAge', age);
            setCookie('userGender', gender);
            setCookie('userCustomGenderName', customGenderName);
            setCookie('userCustomGenderEmoji', customGenderEmoji);

            ui.myNicknameDisplay.textContent = nickname;
            loadCountries().then(() => {
                showView('country-setup-view');
            });
        });
        
        // ... (All other event listeners) ...

        window.onload = () => { 
            loadAllSettingsFromCookies();
            checkProfile();
        };

    </script>
</body>
</html>
