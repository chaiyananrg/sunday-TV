<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sunday Live - The Ultimate Experience</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.umd.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --sunrise-start: #ffc371; --sunrise-end: #ff5f6d;
            --sky-blue: #89f7fe; --sky-end: #66a6ff;
            --text-dark: #2c3e50; --text-light: #fdfdfd;
            --card-bg: rgba(255, 255, 255, 0.85);
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            --radius: 16px;
        }
        body {
            font-family: 'Kanit', sans-serif; margin: 0;
            background: linear-gradient(135deg, var(--sky-blue), var(--sky-end));
            color: var(--text-dark); overflow: hidden;
        }
        .page { position: absolute; top: 0; left: 0; width: 100%; height: 100%; box-sizing: border-box; padding: 24px; opacity: 0; visibility: hidden; transition: opacity 0.4s ease, visibility 0.4s ease; }
        .page.active { opacity: 1; visibility: visible; z-index: 10; }
        #login-page { display: flex; justify-content: center; align-items: center; }
        .login-box { background: var(--card-bg); backdrop-filter: blur(10px); padding: 40px 50px; border-radius: var(--radius); box-shadow: var(--shadow); text-align: center; animation: fadeIn 0.8s ease-out; }
        .login-box h1 { font-size: 3rem; font-weight: 700; background: -webkit-linear-gradient(45deg, var(--sunrise-end), #66a6ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px; }
        #displayNameInput { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 10px; margin-top: 20px; font-size: 1rem; }
        .btn { display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; border: none; border-radius: 12px; cursor: pointer; font-size: 1rem; font-weight: 500; transition: all 0.3s ease; margin-top: 20px; }
        .btn-primary { background: linear-gradient(45deg, var(--sunrise-end), var(--sunrise-start)); color: var(--text-light); }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .btn-success { background: linear-gradient(45deg, #2ed573, #1e90ff); color: white; }
        
        #home-page header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        #home-page .header-card { background: var(--card-bg); backdrop-filter: blur(5px); padding: 12px 20px; border-radius: var(--radius); box-shadow: var(--shadow); }
        #coin-area input { padding: 8px; border-radius: 8px; border: 1px solid #ccc; width: 80px; }
        .live-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 24px; margin-top: 30px; }
        .live-card { background: white; border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); cursor: pointer; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .live-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,0.15); }
        .live-card .thumbnail { width: 100%; height: 180px; background: linear-gradient(45deg, #eee, #ddd); display: flex; justify-content: center; align-items: center; }
        .live-card-info { padding: 15px; }
        .live-card-info h4 { margin: 0 0 5px 0; }
        
        #live-room-page { background: #111; padding: 0; top: 100%; transition: top 0.5s cubic-bezier(0.77, 0, 0.175, 1); }
        #live-room-page.active { top: 0; z-index: 20; }
        .live-room-header { position: absolute; top: 0; left: 0; width: 100%; padding: 20px; box-sizing: border-box; z-index: 30; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(180deg, rgba(0,0,0,0.5), transparent); }
        .live-room-header h3 { color: white; margin: 0; display: flex; align-items: center; gap: 10px; }
        .live-badge { background-color: #ff4757; color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.9rem; font-weight: 500; animation: pulse 1.5s infinite; }
        .video-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .video-container video { width: 100%; height: 100%; object-fit: cover; }
        .live-overlay { position: absolute; bottom: 0; left: 0; width: 100%; padding: 20px; box-sizing: border-box; z-index: 30; display: flex; flex-direction: column; gap: 10px; background: linear-gradient(0deg, rgba(0,0,0,0.5), transparent); }
        .chat-box { color: white; height: 200px; overflow-y: auto; text-shadow: 1px 1px 2px black; }
        .chat-message { margin-bottom: 8px; }
        .chat-message span { font-weight: bold; color: var(--sunrise-start); }
        .chat-input-area { display: flex; gap: 10px; }
        #chat-input { flex-grow: 1; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 10px; padding: 10px; color: white; outline: none; }
        .main-controls { display: flex; justify-content: space-between; align-items: center; }
        .gift-shop { display: flex; gap: 15px; }
        .icon-btn { background: rgba(255,255,255,0.2); border: none; border-radius: 50%; width: 50px; height: 50px; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: background 0.3s; color: white; flex-shrink: 0; }
        .icon-btn:hover { background: rgba(255,255,255,0.4); }
        
        #streamer-controls { display: none; gap: 15px; }
        #streamer-controls.active { display: flex; }
        
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 71, 87, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); } }
    </style>
</head>
<body>

    <div id="login-page" class="page active">
        <div class="login-box">
            <h1>Sunday Live</h1>
            <p>ไลฟ์วันสบายๆ สไตล์คุณ</p>
            <input type="text" id="displayNameInput" placeholder="กรอกชื่อของคุณ...">
            <button id="login-btn" class="btn btn-primary"><i data-lucide="log-in"></i><span>เข้าสู่ระบบ</span></button>
        </div>
    </div>

    <div id="home-page" class="page">
        <header>
            <div id="userInfo" class="header-card"><h3>สวัสดี, <span id="usernameDisplay"></span>!</h3></div>
            <div id="coin-area" class="header-card">
                <i data-lucide="coins"></i>
                <span>ยอดเหรียญ: <span id="coinBalance">0</span></span>
                <input type="number" id="rechargeAmount" placeholder="จำนวนเงิน">
                <button id="recharge-btn" class="btn">เติม</button>
            </div>
        </header>
        <div class="home-actions">
            <button id="start-live-btn" class="btn btn-success"><i data-lucide="video"></i><span>เริ่มไลฟ์สด</span></button>
        </div>
        <h2 style="margin-top: 30px;">ช่องที่กำลังไลฟ์สด</h2>
        <div class="live-grid" id="live-grid">
             <div id="no-live-streams" style="text-align: center; grid-column: 1 / -1; padding: 20px;">ยังไม่มีใครไลฟ์สดเลย... คุณเป็นคนแรกสิ!</div>
        </div>
    </div>

    <div id="live-room-page" class="page">
        <div class="live-room-header">
            <h3 id="live-room-title"></h3>
            <button id="leave-room-btn" class="icon-btn"><i data-lucide="x"></i></button>
        </div>
        <div class="video-container" id="video-container">[ กำลังโหลดวิดีโอ... ]</div>
        <div class="live-overlay">
            <div class="chat-box" id="chat-box"></div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" placeholder="พิมพ์ข้อความ...">
                <button id="send-chat-btn" class="icon-btn"><i data-lucide="send"></i></button>
            </div>
            <div class="main-controls">
                <div id="streamer-controls">
                    <button id="mic-btn" class="icon-btn"><i id="mic-icon" data-lucide="mic"></i></button>
                    <button id="cam-btn" class="icon-btn"><i id="cam-icon" data-lucide="video"></i></button>
                </div>
                <div class="gift-shop">
                    <button class="icon-btn" data-gift="heart" data-cost="1"><i data-lucide="heart"></i></button>
                    <button class="icon-btn" data-gift="sun" data-cost="99"><i data-lucide="sun"></i></button>
                    <button class="icon-btn" data-gift="rocket" data-cost="500"><i data-lucide="rocket"></i></button>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const App = (() => {
        // --- State & Config ---
        const LIVEKIT_URL = 'wss://sunday-group-cy6t1e76.livekit.cloud';
        const LIVEKIT_API_KEY = 'APIG6ZjPHKfdoPq';
        const LIVEKIT_API_SECRET = 'b6SMZCXSjgE2ee0XfkZi870J4c8Gt2cdqViAlKff2gPE';
        const PROFANITY_LIST = ['เหี้ย', 'สัส', 'ควย', 'หี', 'เย็ด', 'ไอ้สัส', 'อีดอก'];
        
        let currentUsername = '';
        let coinBalance = 100;
        let currentRoom = null;
        let liveRooms = [];
        let currentLiveIndex = -1;
        let isSwitching = false;
        let streamerWarnings = 0;
        let isBlocked = false;
        let blockTimeoutId = null;
        const textEncoder = new TextEncoder();
        const textDecoder = new TextDecoder();
        
        // --- DOM Elements ---
        const pages = document.querySelectorAll('.page');
        const usernameDisplay = document.getElementById('usernameDisplay');
        const coinBalanceDisplay = document.getElementById('coinBalance');
        const displayNameInput = document.getElementById('displayNameInput');
        const chatBox = document.getElementById('chat-box');
        const liveRoomTitle = document.getElementById('live-room-title');
        const videoContainer = document.getElementById('video-container');
        const liveGrid = document.getElementById('live-grid');
        const streamerControls = document.getElementById('streamer-controls');
        const chatInput = document.getElementById('chat-input');

        function init() {
            if (typeof lucide === 'undefined' || typeof livekit === 'undefined') {
                console.error("Essential libraries (Lucide or LiveKit) are not loaded.");
                Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถโหลดไลบรารี่ที่จำเป็นได้ กรุณาลองรีเฟรชหน้าเว็บ', 'error');
                return;
            }
            lucide.createIcons();
            attachEventListeners();
            updateCoinDisplay();
        }

        function attachEventListeners() {
            document.getElementById('login-btn').addEventListener('click', login);
            displayNameInput.addEventListener('keyup', e => { if (e.key === 'Enter') login(); });
            document.getElementById('recharge-btn').addEventListener('click', rechargeCoins);
            document.getElementById('start-live-btn').addEventListener('click', startMyOwnLive);
            document.getElementById('leave-room-btn').addEventListener('click', () => leaveLiveRoom(true));
            document.getElementById('live-room-page').addEventListener('wheel', handleLiveScroll);
            document.getElementById('mic-btn').addEventListener('click', toggleMic);
            document.getElementById('cam-btn').addEventListener('click', toggleCam);
            document.getElementById('send-chat-btn').addEventListener('click', sendChatMessage);
            chatInput.addEventListener('keyup', e => { if (e.key === 'Enter') sendChatMessage(); });
            document.querySelectorAll('.gift-shop .icon-btn[data-gift]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const gift = btn.dataset.gift;
                    const cost = parseInt(btn.dataset.cost, 10);
                    sendGift(gift, cost);
                });
            });
        }

        function showPage(pageId) {
            pages.forEach(page => page.classList.remove('active'));
            const targetPage = document.getElementById(pageId);
            if(targetPage) targetPage.classList.add('active');
        }

        function updateCoinDisplay() {
            if (coinBalanceDisplay) coinBalanceDisplay.textContent = coinBalance;
        }

        function login() {
            const name = displayNameInput.value.trim();
            if (!name) { Swal.fire({ icon: 'error', title: 'ผิดพลาด', text: 'กรุณากรอกชื่อด้วยครับ' }); return; }
            currentUsername = name;
            usernameDisplay.textContent = currentUsername;
            updateCoinDisplay();
            Swal.fire({ icon: 'success', title: `ยินดีต้อนรับ, ${name}!`, timer: 1500, showConfirmButton: false })
               .then(() => showPage('home-page'));
        }

        function rechargeCoins() {
            const amountInput = document.getElementById('rechargeAmount');
            const amount = parseInt(amountInput.value);
            if (isNaN(amount) || amount <= 0) {
                Swal.fire({ icon: 'warning', title: 'ผิดพลาด', text: 'กรุณากรอกจำนวนเงินที่ถูกต้อง' });
                return;
            }
            coinBalance += amount;
            updateCoinDisplay();
            Swal.fire({ icon: 'success', title: 'เติมเงินสำเร็จ!', text: `คุณได้รับ ${amount} เหรียญ`, timer: 2000, showConfirmButton: false });
            amountInput.value = '';
        }

        function containsProfanity(text) {
            return PROFANITY_LIST.some(word => text.toLowerCase().includes(word));
        }

        async function generateToken(roomName, participantName) {
            // FIX: Access livekit from window object
            const { AccessToken } = window.livekit;
            const at = new AccessToken(LIVEKIT_API_KEY, LIVEKIT_API_SECRET, { identity: participantName });
            at.addGrant({ roomJoin: true, room: roomName, canPublish: true, canSubscribe: true, canPublishData: true });
            return at.toJwt();
        }

        async function connectToLiveKit(roomName, isStreamer) {
            if (currentRoom) await leaveLiveRoom(false);
            
            // FIX: Access livekit from window object
            const { Room, RoomEvent } = window.livekit;
            const token = await generateToken(roomName, currentUsername);
            currentRoom = new Room();

            Swal.fire({ title: 'กำลังเชื่อมต่อ...', text: `กำลังเข้าสู่ห้อง ${roomName}`, allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            try {
                await currentRoom.connect(LIVEKIT_URL, token);
                Swal.close();
                liveRoomTitle.innerHTML = `${roomName} <span class="live-badge">LIVE</span>`;
                lucide.createIcons();
                document.getElementById('live-room-page').classList.add('active');
                streamerControls.classList.toggle('active', isStreamer);
                chatBox.innerHTML = '';

                const handleTrack = (track, participant) => {
                    if (track.kind === 'video') {
                        videoContainer.innerHTML = '';
                        const videoElement = track.attach();
                        videoContainer.appendChild(videoElement);
                    }
                };

                if (isStreamer) {
                    streamerWarnings = 0;
                    await currentRoom.localParticipant.enableCameraAndMicrophone();
                }
                
                currentRoom.localParticipant.tracks.forEach(pub => {
                    if (pub.track) handleTrack(pub.track, currentRoom.localParticipant);
                });

                currentRoom.participants.forEach(participant => {
                    participant.tracks.forEach(pub => {
                        if (pub.track) handleTrack(pub.track, participant);
                    });
                    participant.on(RoomEvent.TrackSubscribed, (track) => handleTrack(track, participant));
                });
                
                currentRoom.on(RoomEvent.ParticipantDisconnected, () => {
                    videoContainer.innerHTML = '<h3>ผู้ถ่ายทอดสดออกจากห้องไปแล้ว</h3>';
                });

                currentRoom.on(RoomEvent.DataReceived, (payload, participant) => {
                    const data = JSON.parse(textDecoder.decode(payload));
                    if (data.type === 'chat') {
                        appendChatMessage(data.user, data.message);
                    }
                });

            } catch (error) {
                console.error('Connection failed:', error);
                Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถเชื่อมต่อห้องไลฟ์ได้', 'error');
            }
        }

        async function startMyOwnLive() {
            if (isBlocked) {
                Swal.fire('ถูกระงับ', 'คุณถูกระงับการไลฟ์สดชั่วคราว', 'error');
                return;
            }
            const { value: roomName } = await Swal.fire({ title: 'ตั้งชื่อช่องไลฟ์ของคุณ', input: 'text', inputPlaceholder: 'เช่น MySundayLive', showCancelButton: true, inputValidator: v => !v && 'กรุณาตั้งชื่อช่อง!' });
            if (roomName) {
                addNewLiveCard(roomName, currentUsername);
                currentLiveIndex = liveRooms.findIndex(r => r.name === roomName);
                connectToLiveKit(roomName, true);
            }
        }

        function joinLive(roomName) {
            currentLiveIndex = liveRooms.findIndex(r => r.name === roomName);
            if (currentLiveIndex === -1) return;
            connectToLiveKit(roomName, false);
        }

        async function leaveLiveRoom(switchToHome = true) {
            if (currentRoom) {
                await currentRoom.disconnect();
                currentRoom = null;
            }
            document.getElementById('live-room-page').classList.remove('active');
            if (switchToHome) showPage('home-page');
        }

        function addNewLiveCard(roomName, streamerName) {
            if (liveRooms.some(r => r.name === roomName)) return;
            liveRooms.push({ name: roomName, streamer: streamerName });
            renderLiveCards();
        }
        
        function renderLiveCards() {
            liveGrid.innerHTML = '';
            if (liveRooms.length === 0) {
                liveGrid.innerHTML = `<div id="no-live-streams" style="text-align: center; grid-column: 1 / -1; padding: 20px;">ยังไม่มีใครไลฟ์สดเลย... คุณเป็นคนแรกสิ!</div>`;
                return;
            }
            
            liveRooms.forEach(room => {
                const card = document.createElement('div');
                card.className = 'live-card';
                card.addEventListener('click', () => joinLive(room.name));
                card.innerHTML = `<div class="thumbnail"><i data-lucide="clapperboard" style="width: 48px; height: 48px;"></i></div>
                                  <div class="live-card-info"><h4>${room.name}</h4><p>โดย: ${room.streamer}</p></div>`;
                liveGrid.appendChild(card);
            });
            lucide.createIcons();
        }
        
        function handleLiveScroll(event) {
            if (isSwitching) return;
            isSwitching = true;
            
            const direction = event.deltaY > 0 ? 'up' : 'down';
            let nextIndex = currentLiveIndex;

            if (direction === 'up') nextIndex++;
            else nextIndex--;

            if (nextIndex >= 0 && nextIndex < liveRooms.length) {
                const nextRoom = liveRooms[nextIndex];
                currentLiveIndex = nextIndex;
                connectToLiveKit(nextRoom.name, false);
            }

            setTimeout(() => { isSwitching = false; }, 1000);
        }

        function sendChatMessage() {
            const message = chatInput.value.trim();
            if (!message || !currentRoom) return;

            const isStreamer = currentRoom.localParticipant.identity === currentUsername;
            
            if (containsProfanity(message)) {
                if (isStreamer) {
                    streamerWarnings++;
                    if (streamerWarnings >= 4) {
                        Swal.fire('ไลฟ์ถูกปิด!', 'คุณละเมิดกฎชุมชนครบ 4 ครั้ง ไลฟ์ของคุณจะถูกปิดและระงับ 3 นาที', 'error').then(() => {
                            leaveLiveRoom(true);
                            isBlocked = true;
                            blockTimeoutId = setTimeout(() => {
                                isBlocked = false;
                                Swal.fire('ปลดล็อคแล้ว', 'คุณสามารถไลฟ์สดได้อีกครั้ง', 'success');
                            }, 180000); // 3 minutes
                        });
                        return;
                    } else {
                        Swal.fire('คำเตือน!', `ตรวจพบคำไม่เหมาะสม นี่คือคำเตือนครั้งที่ ${streamerWarnings}/3`, 'warning');
                    }
                } else {
                    Swal.fire('คำเตือน!', 'โปรดใช้คำสุภาพในการแสดงความคิดเห็น', 'warning');
                    return;
                }
            }
            
            const data = { type: 'chat', user: currentUsername, message: message };
            const payload = textEncoder.encode(JSON.stringify(data));
            currentRoom.localParticipant.publishData(payload, { reliable: true });
            
            chatInput.value = '';
        }

        function appendChatMessage(user, message) {
            const messageEl = document.createElement('div');
            messageEl.className = 'chat-message';
            messageEl.innerHTML = `<span>${user}:</span> ${message}`;
            chatBox.appendChild(messageEl);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function sendGift(giftType, cost) {
            if (coinBalance < cost) { Swal.fire({ icon: 'warning', title: 'เหรียญไม่พอ', text: 'เหรียญของคุณไม่เพียงพอ!' }); return; }
            coinBalance -= cost;
            updateCoinDisplay();
            const chatMessage = document.createElement('div');
            chatMessage.className = 'chat-message';
            chatMessage.innerHTML = `<span>${currentUsername}</span> ได้ส่งของขวัญ!`;
            chatBox.appendChild(chatMessage);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function toggleMic() {
            if(!currentRoom) return;
            const enabled = currentRoom.localParticipant.isMicrophoneEnabled;
            currentRoom.localParticipant.setMicrophoneEnabled(!enabled);
            document.getElementById('mic-icon').setAttribute('data-lucide', enabled ? 'mic-off' : 'mic');
            lucide.createIcons();
        }

        function toggleCam() {
            if(!currentRoom) return;
            const enabled = currentRoom.localParticipant.isCameraEnabled;
            currentRoom.localParticipant.setCameraEnabled(!enabled);
            document.getElementById('cam-icon').setAttribute('data-lucide', enabled ? 'video-off' : 'video');
            lucide.createIcons();
        }

        return { init };
    })();

    App.init();
});
</script>
</body>
</html>
