<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sunday TV</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            touch-action: manipulation; /* ปรับปรุงการตอบสนองต่อการสัมผัส */
            -webkit-tap-highlight-color: transparent; /* ลบไฮไลท์เมื่อแตะบน iOS */
        }
        /* Sky Gradient Background */
        .sky-background {
            background: linear-gradient(170deg, #87CEEB 0%, #FFDAB9 80%, #FFC371 100%);
        }
        /* Main Video Styling */
        #remote-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            background-color: #222;
        }
        /* Local Video Container - Default (Portrait) */
        #local-video-container {
            position: absolute;
            bottom: 8rem; /* ยกสูงขึ้นเพื่อไม่ให้บังปุ่ม */
            left: 50%;
            transform: translateX(-50%);
            width: 30%;
            max-width: 140px;
            aspect-ratio: 3 / 4;
            border-radius: 1rem;
            overflow: hidden;
            border: 3px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
            z-index: 20;
            transition: all 0.3s ease-in-out;
        }
        #local-video {
             width: 100%;
             height: 100%;
             object-fit: cover;
             transform: scaleX(-1);
        }
        /* Responsive Layout for Landscape Mode */
        @media (orientation: landscape) {
            #local-video-container {
                bottom: auto;
                left: auto;
                top: 50%;
                right: 1.5rem;
                transform: translateY(-50%);
                width: 25%;
                height: auto;
                max-width: 200px;
                max-height: 70vh;
            }
        }
        /* Themed Buttons */
        .themed-btn {
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #FFC107; /* Sunflower Yellow */
            box-shadow: 0 4px 10px rgba(0,0,0,0.2), inset 0 -4px 6px rgba(0,0,0,0.1);
            transition: all 0.2s ease-in-out;
        }
        .themed-btn:hover {
            transform: scale(1.1);
            background-color: #FFD54F;
        }
        .themed-btn:active {
            transform: scale(1.05);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2), inset 0 -2px 4px rgba(0,0,0,0.1);
        }
        /* Spinning Sun Loader */
        .sun-loader {
            width: 80px;
            height: 80px;
            position: relative;
            animation: spin 10s linear infinite;
        }
        .sun-loader .sun-body {
            width: 50px;
            height: 50px;
            background-color: #FFC107;
            border-radius: 50%;
            position: absolute;
            top: 15px;
            left: 15px;
        }
        .sun-loader .sun-ray {
            background-color: #FFC107;
            width: 6px;
            height: 18px;
            border-radius: 3px;
            position: absolute;
            top: -3px;
            left: 37px;
        }
        .sun-ray:nth-child(2) { transform: rotate(45deg); top: 8px; left: 58px; }
        .sun-ray:nth-child(3) { transform: rotate(90deg); top: 31px; left: 65px; }
        .sun-ray:nth-child(4) { transform: rotate(135deg); top: 54px; left: 58px; }
        .sun-ray:nth-child(5) { transform: rotate(180deg); top: 67px; left: 37px; }
        .sun-ray:nth-child(6) { transform: rotate(225deg); top: 54px; left: 16px; }
        .sun-ray:nth-child(7) { transform: rotate(270deg); top: 31px; left: 9px; }
        .sun-ray:nth-child(8) { transform: rotate(315deg); top: 8px; left: 16px; }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden">

    <!-- ส่วนตั้งค่าเริ่มต้น -->
    <div id="settings-view" class="sky-background w-full h-full flex flex-col items-center justify-center p-6 relative overflow-hidden">
        <!-- Sun element -->
        <div class="absolute -top-20 -right-20 w-64 h-64 bg-yellow-300 rounded-full opacity-80"></div>
        
        <div class="bg-white/80 backdrop-blur-sm p-8 rounded-3xl shadow-2xl w-full max-w-md text-center z-10">
            <h1 class="text-5xl font-bold text-gray-800 mb-2">Sunday TV</h1>
            <p class="text-gray-600 mb-8">พบเพื่อนใหม่ใต้แสงตะวัน</p>
            
            <div class="space-y-4 text-left">
                <div>
                    <label for="my-country" class="block mb-1 text-sm font-medium text-gray-700">ประเทศของคุณ</label>
                    <select id="my-country" class="w-full p-3 bg-gray-100 border-2 border-transparent focus:border-yellow-400 focus:ring-0 rounded-xl transition">
                        <option>กำลังโหลด...</option>
                    </select>
                </div>
                <div>
                    <label for="partner-country" class="block mb-1 text-sm font-medium text-gray-700">ค้นหาเพื่อนจาก</label>
                    <select id="partner-country" class="w-full p-3 bg-gray-100 border-2 border-transparent focus:border-yellow-400 focus:ring-0 rounded-xl transition">
                        <option value="worldwide">ทั่วโลก</option>
                        <option>กำลังโหลด...</option>
                    </select>
                </div>
            </div>

            <button id="start-btn" class="w-full mt-8 bg-yellow-400 hover:bg-yellow-500 text-gray-800 font-bold py-4 px-4 rounded-xl text-xl transition-transform duration-200 active:scale-95 shadow-lg">
                เริ่มเลย!
            </button>
            <div id="user-id-display" class="mt-4 text-xs text-gray-500 text-center"></div>
        </div>
        
        <!-- Sunflower SVG -->
        <div class="absolute -bottom-12 -left-12 w-48 h-48 opacity-40 z-0">
             <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><g transform="translate(50,50)"><circle r="20" fill="#654321"/><g id="petals" transform="scale(1.1)"><path d="M0,-20 A20,20 0 0,1 10,-17.32 L0,0 Z" fill="#FFC107" transform="rotate(0)"/><path d="M0,-20 A20,20 0 0,1 10,-17.32 L0,0 Z" fill="#FFC107" transform="rotate(30)"/><path d="M0,-20 A20,20 0 0,1 10,-17.32 L0,0 Z" fill="#FFC107" transform="rotate(60)"/><path d="M0,-20 A20,20 0 0,1 10,-17.32 L0,0 Z" fill="#FFC107" transform="rotate(90)"/><path d="M0,-20 A20,20 0 0,1 10,-17.32 L0,0 Z" fill="#FFC107" transform="rotate(120)"/><path d="M0,-20 A20,20 0 0,1 10,-17.32 L0,0 Z" fill="#FFC107" transform="rotate(150)"/><path d="M0,-20 A20,20 0 0,1 10,-17.32 L0,0 Z" fill="#FFC107" transform="rotate(180)"/><path d="M0,-20 A20,20 0 0,1 10,-17.32 L0,0 Z" fill="#FFC107" transform="rotate(210)"/><path d="M0,-20 A20,20 0 0,1 10,-17.32 L0,0 Z" fill="#FFC107" transform="rotate(240)"/><path d="M0,-20 A20,20 0 0,1 10,-17.32 L0,0 Z" fill="#FFC107" transform="rotate(270)"/><path d="M0,-20 A20,20 0 0,1 10,-17.32 L0,0 Z" fill="#FFC107" transform="rotate(300)"/><path d="M0,-20 A20,20 0 0,1 10,-17.32 L0,0 Z" fill="#FFC107" transform="rotate(330)"/></g></g></svg>
        </div>
    </div>

    <!-- ส่วนแสดงผลขณะค้นหา -->
    <div id="loading-view" class="hidden sky-background w-full h-full flex-col items-center justify-center text-center p-6">
        <div class="sun-loader mb-8">
            <div class="sun-body"></div>
            <div class="sun-ray"></div><div class="sun-ray"></div><div class="sun-ray"></div><div class="sun-ray"></div>
            <div class="sun-ray"></div><div class="sun-ray"></div><div class="sun-ray"></div><div class="sun-ray"></div>
        </div>
        <h2 class="text-3xl font-semibold text-white text-shadow">กำลังค้นหาเพื่อน...</h2>
        <p class="text-white/80 mt-2">โปรดรอสักครู่ แสงตะวันกำลังนำทาง</p>
        <button id="cancel-search-btn" class="mt-12 bg-white/30 hover:bg-white/50 backdrop-blur-sm text-white font-bold py-3 px-8 rounded-full transition duration-300">
            ยกเลิก
        </button>
    </div>

    <!-- ส่วนวิดีโอแชท -->
    <div id="chat-view" class="hidden w-full h-full bg-black relative">
        <video id="remote-video" autoplay playsinline></video>
        
        <div id="local-video-container">
            <video id="local-video" autoplay playsinline muted></video>
        </div>

        <div class="absolute bottom-6 w-full flex items-center justify-center space-x-6 z-30">
            <button id="stop-btn" class="themed-btn w-16 h-16 bg-red-500 hover:bg-red-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" class="bi bi-telephone-x-fill text-white" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.885.511a1.745 1.745 0 0 1 2.61.163L6.29 2.98c.329.423.445.974.28 1.465l-.413 1.239a.63.63 0 0 0 .317.792l.402.202a1.75 1.75 0 0 0 2.056-.577l1.405-1.405a.63.63 0 0 0 .292-.415l.23-1.015c.12-.52.569-.924 1.09-1.135l.934-.337a.63.63 0 0 0 .42-.626V1.321a1.745 1.745 0 0 1 1.052-1.664h.004a1.745 1.745 0 0 1 1.744 1.744v.002a.63.63 0 0 0 .627.42l.933.337c.521.21.97.615 1.09 1.135l.23 1.015a.63.63 0 0 0 .292.415l1.405 1.405a1.75 1.75 0 0 0 2.056.577l.402-.202a.63.63 0 0 0 .317-.792l-.414-1.24a.97.97 0 0 1 .28-1.465l1.752-2.296a1.745 1.745 0 0 1 2.61-.163l.636.563a1.745 1.745 0 0 1-1.664 1.052h-.004a1.745 1.745 0 0 1-1.744-1.744v-.002a.63.63 0 0 0-.627-.42l-.933-.337a.97.97 0 0 1-1.09-1.135l-.23-1.015a.63.63 0 0 0-.292-.415L9.98 1.71a1.75 1.75 0 0 0-2.056-.577l-.402.202a.63.63 0 0 0-.317.792l.414 1.24a.97.97 0 0 1-.28 1.465L5.01 6.29c-.423.329-.974.445-1.465.28l-1.239-.414a.63.63 0 0 0-.792.317l-.202.402a1.75 1.75 0 0 0 .577 2.056l1.405 1.405a.63.63 0 0 0 .415.292l1.015.23c.52.12.924.569 1.135 1.09l.337.934a.63.63 0 0 0 .626.42h.004a1.745 1.745 0 0 1 1.664 1.052l-.563.636a1.745 1.745 0 0 1-1.052-1.664v-.002a.63.63 0 0 0-.42-.627l-.337-.933a.97.97 0 0 1-1.135-1.09l-1.015-.23a.63.63 0 0 0-.415-.292L2.98 6.29a1.75 1.75 0 0 0-.577-2.056l-.202-.402a.63.63 0 0 0-.792.317l-.414 1.239c-.165.49-.62.86-1.12.965l-.934.198a1.745 1.745 0 0 1-1.895-.886z"/><path fill-rule="evenodd" d="M10.146 4.646a.5.5 0 0 1 .708 0L12.5 6.293l1.646-1.647a.5.5 0 0 1 .708.708L13.207 7l1.647 1.646a.5.5 0 0 1-.708.708L12.5 7.707l-1.646 1.647a.5.5 0 0 1-.708-.708L11.793 7l-1.647-1.646a.5.5 0 0 1 0-.708z"/></svg>
            </button>
            <button id="next-btn" class="themed-btn w-20 h-20">
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor" class="bi bi-arrow-right text-white" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 8a.5.5 0 0 1 .5-.5h5.793L8.146 5.354a.5.5 0 1 1 .708-.708l3 3a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708-.708L10.293 8.5H4.5A.5.5 0 0 1 4 8z"/></svg>
            </button>
        </div>
    </div>

    <!-- Modal สำหรับการแจ้งเตือน -->
    <div id="alert-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
        <div class="bg-white/90 backdrop-blur-sm rounded-2xl shadow-xl p-6 w-full max-w-sm text-center text-gray-800">
            <p id="alert-modal-message" class="text-lg mb-6"></p>
            <button id="alert-modal-close" class="w-full bg-yellow-400 hover:bg-yellow-500 text-gray-800 font-bold py-3 px-6 rounded-lg active:scale-95 transition-transform">
                เข้าใจแล้ว
            </button>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDocs, onSnapshot, updateDoc, deleteDoc, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAyLE1l-eiPPW-fJIvL2uULmDWXcKRhoEM",
            authDomain: "sunday-tv-videocall.firebaseapp.com",
            projectId: "sunday-tv-videocall",
            storageBucket: "sunday-tv-videocall.firebasestorage.app",
            messagingSenderId: "456379728267",
            appId: "1:456379728267:web:815ef8f00b815e42172f8e",
            measurementId: "G-WMDT7EYYQD"
        };
        
        const appId = firebaseConfig.appId;
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let localStream, remoteStream, peerConnection, currentRoomId, userId, unsubscribeRoom;
        
        const servers = {
            iceServers: [{ urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }],
            iceCandidatePoolSize: 10,
        };
        
        const roomsCollection = collection(db, `artifacts/${appId}/public/data/rooms`);

        const settingsView = document.getElementById('settings-view');
        const loadingView = document.getElementById('loading-view');
        const chatView = document.getElementById('chat-view');
        const startBtn = document.getElementById('start-btn');
        const cancelSearchBtn = document.getElementById('cancel-search-btn');
        const stopBtn = document.getElementById('stop-btn');
        const nextBtn = document.getElementById('next-btn');
        const localVideo = document.getElementById('local-video');
        const remoteVideo = document.getElementById('remote-video');
        const myCountrySelect = document.getElementById('my-country');
        const partnerCountrySelect = document.getElementById('partner-country');
        const userIdDisplay = document.getElementById('user-id-display');
        const alertModal = document.getElementById('alert-modal');
        const alertModalMessage = document.getElementById('alert-modal-message');
        const alertModalClose = document.getElementById('alert-modal-close');

        async function loadCountries() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/ponlawat-w/country-list-th/refs/heads/master/country-list-th.json');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const countryData = await response.json();
                populateCountries(countryData);
            } catch (error) {
                console.error("Could not load country list:", error);
                const fallbackCountries = [{name: 'ไทย', alpha2: 'TH'}, {name: 'สหรัฐอเมริกา', alpha2: 'US'}];
                populateCountries(fallbackCountries);
                showAlert("ไม่สามารถโหลดรายชื่อประเทศได้ ใช้รายชื่อสำรองแทน");
            }
        }

        function populateCountries(countries) {
            myCountrySelect.innerHTML = '';
            partnerCountrySelect.innerHTML = '<option value="worldwide">ทั่วโลก</option>';
            countries.sort((a, b) => a.name.localeCompare(b.name, 'th'));
            countries.forEach(country => {
                if (country.name && country.alpha2) {
                    const option1 = new Option(country.name, country.alpha2);
                    const option2 = new Option(country.name, country.alpha2);
                    myCountrySelect.add(option1);
                    partnerCountrySelect.add(option2);
                }
            });
            if (myCountrySelect.querySelector('option[value="TH"]')) {
               myCountrySelect.value = 'TH';
            }
        }
        
        function showAlert(message) {
            alertModalMessage.textContent = message;
            alertModal.classList.remove('hidden');
            alertModal.classList.add('flex');
        }

        alertModalClose.addEventListener('click', () => {
            alertModal.classList.add('hidden');
            alertModal.classList.remove('flex');
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                userIdDisplay.textContent = `ID: ${userId.substring(0, 12)}...`;
                startBtn.disabled = false;
                startBtn.textContent = 'เริ่มเลย!';
            } else {
                await initializeAuth();
            }
        });

        async function initializeAuth() {
            startBtn.disabled = true;
            startBtn.textContent = 'กำลังเชื่อมต่อ...';
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Authentication failed:", error);
                if (error.code === 'auth/configuration-not-found') {
                    userIdDisplay.innerHTML = `<span class="text-red-500 font-bold">การตั้งค่าผิดพลาด:</span><br><span class="text-sm text-gray-600">กรุณาเปิดใช้งานผู้ให้บริการ "Anonymous" ใน Firebase Console</span>`;
                    startBtn.textContent = 'ตั้งค่าไม่สำเร็จ';
                    startBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                    startBtn.classList.remove('bg-yellow-400', 'hover:bg-yellow-500');
                } else {
                    userIdDisplay.textContent = "การเชื่อมต่อล้มเหลว กรุณาลองใหม่";
                }
            }
        }

        const startChat = async () => {
            if (startBtn.disabled) return;
            settingsView.style.display = 'none';
            loadingView.style.display = 'flex';
            chatView.style.display = 'none';
            
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;
            } catch (error) {
                console.error("Could not get user media:", error);
                showAlert("กรุณาอนุญาตให้เข้าถึงกล้องและไมโครโฟนเพื่อเริ่มใช้งาน");
                resetToSettings();
                return;
            }

            const partnerCountry = partnerCountrySelect.value;
            const q = partnerCountry === 'worldwide'
                ? query(roomsCollection, where("status", "==", "waiting"))
                : query(roomsCollection, where("status", "==", "waiting"), where("offererCountry", "==", partnerCountry));

            const querySnapshot = await getDocs(q);
            const availableRooms = [];
            querySnapshot.forEach(doc => {
                if (doc.data().offererId !== userId) {
                    availableRooms.push({ id: doc.id, ...doc.data() });
                }
            });

            if (availableRooms.length > 0) {
                await joinRoom(availableRooms[0].id, availableRooms[0].offer);
            } else {
                await createRoom();
            }
        };

        const createRoom = async () => {
            peerConnection = new RTCPeerConnection(servers);
            registerPeerConnectionListeners();
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            
            const roomData = {
                offer: { type: offer.type, sdp: offer.sdp },
                offererId: userId,
                offererCountry: myCountrySelect.value,
                status: 'waiting',
                createdAt: serverTimestamp(),
            };
            const roomRef = await addDoc(roomsCollection, roomData);
            currentRoomId = roomRef.id;

            unsubscribeRoom = onSnapshot(roomRef, async (snapshot) => {
                const data = snapshot.data();
                if (data && data.answer && !peerConnection.currentRemoteDescription) {
                    const remoteDesc = new RTCSessionDescription(data.answer);
                    await peerConnection.setRemoteDescription(remoteDesc);
                    await updateDoc(roomRef, { status: 'connected' });
                }
            });

            const answerCandidatesCollection = collection(db, `artifacts/${appId}/public/data/rooms/${currentRoomId}/answerCandidates`);
            onSnapshot(answerCandidatesCollection, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') peerConnection.addIceCandidate(new RTCIceCandidate(change.doc.data()));
                });
            });
        };

        const joinRoom = async (roomId, offer) => {
            currentRoomId = roomId;
            peerConnection = new RTCPeerConnection(servers);
            registerPeerConnectionListeners();
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            
            await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
            
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            
            const roomRef = doc(db, `artifacts/${appId}/public/data/rooms/${currentRoomId}`);
            await updateDoc(roomRef, { 
                answer: { type: answer.type, sdp: answer.sdp },
                answererId: userId,
                answererCountry: myCountrySelect.value,
                status: 'connected'
            });

            const offerCandidatesCollection = collection(db, `artifacts/${appId}/public/data/rooms/${currentRoomId}/offerCandidates`);
            onSnapshot(offerCandidatesCollection, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') peerConnection.addIceCandidate(new RTCIceCandidate(change.doc.data()));
                });
            });
        };

        function registerPeerConnectionListeners() {
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    const roomRef = doc(db, `artifacts/${appId}/public/data/rooms/${currentRoomId}`);
                    const candidatesCollectionPath = peerConnection.currentRemoteDescription ? 'answerCandidates' : 'offerCandidates';
                    addDoc(collection(roomRef, candidatesCollectionPath), event.candidate.toJSON());
                }
            };

            peerConnection.ontrack = event => {
                remoteStream = event.streams[0];
                remoteVideo.srcObject = remoteStream;
                switchToChatView();
            };

            peerConnection.onconnectionstatechange = () => {
                if (['disconnected', 'failed', 'closed'].includes(peerConnection.connectionState)) {
                    hangUp(true); // Pass true to auto-find next
                }
            };
        }

        function switchToChatView() {
            loadingView.style.display = 'none';
            chatView.style.display = 'block';
        }
        
        function resetToSettings() {
            loadingView.style.display = 'none';
            chatView.style.display = 'none';
            settingsView.style.display = 'flex';
        }

        const hangUp = async (findNextAfter = false) => {
            if (localStream) localStream.getTracks().forEach(track => track.stop());
            if (peerConnection) peerConnection.close();
            if (unsubscribeRoom) unsubscribeRoom();

            if (currentRoomId) {
                const roomRef = doc(db, `artifacts/${appId}/public/data/rooms/${currentRoomId}`);
                try { await deleteDoc(roomRef); } catch (error) { console.error("Error deleting room:", error); }
            }

            localStream = remoteStream = peerConnection = currentRoomId = unsubscribeRoom = null;
            remoteVideo.srcObject = localVideo.srcObject = null;

            if (findNextAfter) {
                await startChat();
            } else {
                resetToSettings();
            }
        };

        const findNext = () => hangUp(true);
        const stopChat = () => hangUp(false);
        const cancelSearch = () => hangUp(false);

        let touchStartX = 0;
        let touchEndX = 0;

        function checkDirection() {
            if (touchStartX - touchEndX > 75) findNext();
        }

        chatView.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
        chatView.addEventListener('touchend', e => { touchEndX = e.changedTouches[0].screenX; checkDirection(); }, { passive: true });

        startBtn.addEventListener('click', startChat);
        nextBtn.addEventListener('click', findNext);
        stopBtn.addEventListener('click', stopChat);
        cancelSearchBtn.addEventListener('click', cancelSearch);

        window.onload = () => {
            loadCountries();
        };
    </script>
</body>
</html>
