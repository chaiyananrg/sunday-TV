<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sunday TV - พบปะเพื่อนใหม่ทั่วโลก</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mitr:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <style>
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; font-family: 'Mitr', sans-serif;
            -webkit-font-smoothing: antialiased;
            background-color: #0c0a18;
        }
        .screen {
            width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            transition: opacity 0.5s ease, visibility 0.5s;
        }
        .hidden {
            opacity: 0; visibility: hidden; pointer-events: none;
        }
        #home-screen {
            background-image: radial-gradient(at 27% 37%, hsla(215, 98%, 61%, 0.1) 0px, transparent 0%), radial-gradient(at 97% 21%, hsla(125, 98%, 72%, 0.1) 0px, transparent 50%), radial-gradient(at 75% 2%, hsla(257, 98%, 61%, 0.1) 0px, transparent 50%), radial-gradient(at 52% 99%, hsla(355, 98%, 61%, 0.1) 0px, transparent 50%), radial-gradient(at 10% 29%, hsla(256, 96%, 61%, 0.1) 0px, transparent 50%), radial-gradient(at 97% 96%, hsla(38, 60%, 74%, 0.1) 0px, transparent 50%), radial-gradient(at 33% 50%, hsla(222, 67%, 73%, 0.1) 0px, transparent 50%), radial-gradient(at 79% 53%, hsla(343, 68%, 79%, 0.1) 0px, transparent 50%);
            flex-direction: column;
        }
        #chat-screen {
            position: fixed; top: 0; left: 0; background-color: #000;
            /* Default to column (mobile), switch to row on large screens */
            flex-direction: column;
        }
        @media (min-width: 1024px) { /* lg breakpoint */
            #chat-screen {
                flex-direction: row;
            }
        }
        .video-container {
            position: relative;
            overflow: hidden;
            background-color: #1a1a1a;
        }
        video {
            width: 100%; height: 100%; object-fit: cover;
        }
        #localVideo, #local-preview-video {
             transform: scaleX(-1); /* Mirror local video */
        }
        #chat-controls {
            position: absolute; bottom: 32px; left: 50%;
            transform: translateX(-50%); display: flex; gap: 1.5rem;
            padding: 12px; background: rgba(0,0,0,0.3);
            backdrop-filter: blur(10px); border-radius: 999px;
        }
        .control-btn {
            width: 72px; height: 72px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 2rem; color: white; border: none; cursor: pointer;
            transition: all 0.2s;
        }
        .control-btn:hover { transform: scale(1.1); }
    </style>
</head>
<body>

    <!-- Cookie Consent Modal -->
    <div id="cookie-consent-modal" class="hidden fixed inset-0 bg-black/60 z-50 screen">
        <div class="bg-white p-8 rounded-2xl shadow-xl max-w-md text-center m-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">เราใช้คุกกี้เพื่อประสบการณ์ที่ดีขึ้น</h2>
            <p class="text-gray-600 mb-6">เราใช้คุกกี้เพื่อบันทึกการตั้งค่าของคุณ เช่น ชื่อและประเทศที่เลือก เพื่อให้การใช้งานครั้งถัดไปสะดวกยิ่งขึ้น</p>
            <button id="accept-cookie-button" class="w-full px-6 py-3 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 transition-all">ยอมรับและดำเนินการต่อ</button>
        </div>
    </div>

    <!-- Home Screen -->
    <div id="home-screen" class="screen p-4">
        <div class="w-full max-w-lg bg-gray-900/30 backdrop-blur-2xl border border-white/10 p-8 rounded-3xl shadow-2xl text-center">
            <img src="https://img2.pic.in.th/pic/sunday-TV.png" alt="โลโก้ Sunday TV" class="h-24 w-auto mx-auto mb-4" onerror="this.onerror=null; this.src='https://placehold.co/200x80/ffffff/000000?text=Sunday+TV';">
            <div class="space-y-4 text-left">
                <div><label for="userNameInput" class="block text-sm font-medium text-white/80 mb-1">ชื่อของคุณ</label><input type="text" id="userNameInput" placeholder="ใส่ชื่อเล่นของคุณ..." class="w-full p-3 rounded-lg bg-white/10 text-white border-2 border-transparent focus:border-blue-400 focus:ring-0 transition placeholder:text-white/40"></div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div><label for="myCountrySelect" class="block text-sm font-medium text-white/80 mb-1">ประเทศของคุณ</label><select id="myCountrySelect" class="w-full p-3 rounded-lg bg-white/10 text-white border-2 border-transparent focus:border-blue-400 focus:ring-0 transition custom-select"></select></div>
                    <div><label for="partnerCountrySelect" class="block text-sm font-medium text-white/80 mb-1">คนที่อยากพบ</label><select id="partnerCountrySelect" class="w-full p-3 rounded-lg bg-white/10 text-white border-2 border-transparent focus:border-blue-400 focus:ring-0 transition custom-select"></select></div>
                </div>
            </div>
            <div id="local-preview-container" class="hidden w-48 h-36 mx-auto mt-6 rounded-2xl overflow-hidden"><video id="local-preview-video" class="w-full h-full" autoplay playsinline muted></video></div>
            <p id="home-status" class="text-white/70 mt-6 h-6"></p>
            <button id="permission-button" class="mt-4 w-full px-10 py-4 bg-white text-xl font-semibold text-gray-800 rounded-full shadow-lg hover:bg-gray-200 transition-all transform hover:scale-105"><i class="fa-solid fa-camera mr-3"></i>อนุญาตให้ใช้กล้อง</button>
            <button id="start-chat-button" class="hidden mt-4 w-full px-10 py-4 bg-gradient-to-r from-green-400 to-blue-500 text-xl font-semibold text-white rounded-full shadow-lg hover:from-green-500 hover:to-blue-600 transition-all transform hover:scale-105"><i class="fa-solid fa-play mr-3"></i>เริ่มแชท</button>
            <div class="mt-8 text-white/50 text-xs"><p>แชร์ลิงก์ให้เพื่อน:</p><div class="mt-1 flex items-center justify-center bg-black/20 rounded-full p-1"><span id="website-url" class="px-3 truncate"></span><button id="copy-url-button" class="px-3 py-1 bg-white/20 hover:bg-white/30 rounded-full text-white flex-shrink-0">คัดลอก</button></div></div>
        </div>
    </div>

    <!-- Chat Screen -->
    <div id="chat-screen" class="screen hidden">
        <!-- Remote Video Container (Top / Right) -->
        <div id="remote-video-container" class="video-container w-full h-1/2 lg:w-1/2 lg:h-full">
            <video id="remoteVideo" autoplay playsinline></video>
            <div id="waiting-overlay" class="absolute inset-0 flex flex-col items-center justify-center text-white text-xl bg-black bg-opacity-50 z-20"><i class="fa-solid fa-satellite-dish text-5xl mb-4 animate-pulse"></i><p>กำลังค้นหาเพื่อนคุย...</p></div>
        </div>
        <!-- Local Video Container (Bottom / Left) -->
        <div id="local-video-container" class="video-container w-full h-1/2 lg:w-1/2 lg:h-full">
            <video id="localVideo" autoplay playsinline muted></video>
        </div>
        
        <!-- Controls are overlaid on top of the whole screen -->
        <div id="chat-controls" class="z-30">
            <button id="next-button" class="control-btn bg-blue-500 hover:bg-blue-600 shadow-lg shadow-blue-500/50"><i class="fa-solid fa-forward-step"></i></button>
            <button id="stop-button" class="control-btn bg-red-600 hover:bg-red-700 shadow-lg shadow-red-600/50"><i class="fa-solid fa-phone-slash"></i></button>
        </div>
    </div>
    
    <!-- Error Overlay -->
    <div id="error-overlay" class="hidden fixed inset-0 screen bg-gray-800/90 z-50 p-8 text-center"><div class="max-w-md"><h2 id="error-title" class="text-4xl font-bold text-red-500 mb-4"></h2><p id="error-message" class="text-xl text-white/90 mb-6"></p><button onclick="window.location.reload()" class="px-6 py-3 bg-blue-500 text-white font-semibold rounded-lg">ลองอีกครั้ง</button></div></div>

    <script type="module">
        const ui = {
            homeScreen: document.getElementById('home-screen'),
            chatScreen: document.getElementById('chat-screen'),
            cookieModal: document.getElementById('cookie-consent-modal'),
            acceptCookieBtn: document.getElementById('accept-cookie-button'),
            permissionBtn: document.getElementById('permission-button'),
            startChatBtn: document.getElementById('start-chat-button'),
            homeStatus: document.getElementById('home-status'),
            previewContainer: document.getElementById('local-preview-container'),
            previewVideo: document.getElementById('local-preview-video'),
            userNameInput: document.getElementById('userNameInput'),
            myCountrySelect: document.getElementById('myCountrySelect'),
            partnerCountrySelect: document.getElementById('partnerCountrySelect'),
            remoteVideo: document.getElementById('remoteVideo'),
            localVideo: document.getElementById('localVideo'),
            waitingOverlay: document.getElementById('waiting-overlay'),
            nextBtn: document.getElementById('next-button'),
            stopBtn: document.getElementById('stop-button'),
            errorOverlay: document.getElementById('error-overlay'),
            errorTitle: document.getElementById('error-title'),
            errorMessage: document.getElementById('error-message'),
            websiteUrl: document.getElementById('website-url'),
            copyUrlBtn: document.getElementById('copy-url-button'),
        };

        function showScreen(screen) { ui.homeScreen.classList.add('hidden'); ui.chatScreen.classList.add('hidden'); screen.classList.remove('hidden'); }
        function displayError(title, message) { ui.errorTitle.textContent = title; ui.errorMessage.textContent = message; ui.errorOverlay.classList.remove('hidden'); }
        
        function setCookie(name, value, days) { let expires = ""; if (days) { const date = new Date(); date.setTime(date.getTime() + (days*24*60*60*1000)); expires = "; expires=" + date.toUTCString(); } document.cookie = name + "=" + (value || "")  + expires + "; path=/; SameSite=Lax"; }
        function getCookie(name) { const nameEQ = name + "="; const ca = document.cookie.split(';'); for(let i=0; i < ca.length; i++) { let c = ca[i]; while (c.charAt(0)==' ') c = c.substring(1,c.length); if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length); } return null; }

        if (!window.isSecureContext) { displayError('การเชื่อมต่อไม่ปลอดภัย', 'เบราว์เซอร์ต้องการ HTTPS ที่ปลอดภัยเพื่อใช้งานกล้องและไมโครโฟน'); }
        else if (typeof __firebase_config === 'undefined' || !__firebase_config) { displayError('การตั้งค่าไม่สมบูรณ์', 'ไม่พบการตั้งค่าที่จำเป็นสำหรับเชื่อมต่อกับเซิร์ฟเวอร์'); }
        else {
            if (getCookie("cookieConsent") !== "true") { ui.cookieModal.classList.remove('hidden'); } 
            else { initialize(); }
        }
        
        ui.acceptCookieBtn.onclick = () => { setCookie("cookieConsent", "true", 365); ui.cookieModal.classList.add('hidden'); initialize(); };

        let initializeApp, getAuth, signInAnonymously, onAuthStateChanged;
        let getFirestore, doc, collection, setDoc, updateDoc, deleteDoc, onSnapshot, query, where, getDocs, addDoc;
        let db, auth, localStream, peerConnection, currentRoomId, userId;
        let roomUnsubscribe, candidatesUnsubscribe;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(__firebase_config);
        const servers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        const roomsCollectionPath = `artifacts/${appId}/public/data/rooms`;
        const countries = [ { code: 'TH', name: 'ไทย' }, { code: 'US', name: 'สหรัฐอเมริกา' }, { code: 'JP', name: 'ญี่ปุ่น' }, { code: 'KR', name: 'เกาหลีใต้' }, { code: 'GB', name: 'สหราชอาณาจักร' }, { code: 'DE', name: 'เยอรมนี' }, { code: 'FR', name: 'ฝรั่งเศส' }, { code: 'CN', name: 'จีน' }, { code: 'IN', name: 'อินเดีย' }, { code: 'BR', name: 'บราซิล' }, { code: 'RU', name: 'รัสเซีย' }, { code: 'AU', name: 'ออสเตรเลีย' }, { code: 'CA', name: 'แคนาดา' }, { code: 'VN', name: 'เวียดนาม' }, { code: 'ID', name: 'อินโดนีเซีย' } ];

        function populateCountries() {
            countries.forEach(c => { ui.myCountrySelect.add(new Option(c.name, c.code)); });
            ui.partnerCountrySelect.add(new Option('ทั่วโลก', 'worldwide'));
            countries.forEach(c => { ui.partnerCountrySelect.add(new Option(c.name, c.code)); });
        }

        function loadSettings() {
            ui.userNameInput.value = getCookie("userName") || '';
            ui.myCountrySelect.value = getCookie("myCountry") || 'TH';
            ui.partnerCountrySelect.value = getCookie("partnerCountry") || 'worldwide';
        }
        
        function saveSettings() {
            setCookie("userName", ui.userNameInput.value, 365);
            setCookie("myCountry", ui.myCountrySelect.value, 365);
            setCookie("partnerCountry", ui.partnerCountrySelect.value, 365);
        }

        async function initialize() {
            populateCountries();
            loadSettings();
            ui.websiteUrl.textContent = window.location.hostname;
            try {
                ({ initializeApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"));
                ({ getAuth, signInAnonymously, onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"));
                ({ getFirestore, doc, collection, setDoc, updateDoc, deleteDoc, onSnapshot, query, where, getDocs, addDoc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"));
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, user => { if (user) { userId = user.uid; } });
                await signInAnonymously(auth);
            } catch (error) { displayError('การเชื่อมต่อล้มเหลว', `ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้: ${error.message}`); }
        }

        ui.permissionBtn.onclick = async () => {
            if (!ui.userNameInput.value) { ui.homeStatus.textContent = "กรุณาใส่ชื่อของคุณก่อน"; ui.userNameInput.focus(); return; }
            ui.permissionBtn.disabled = true; ui.homeStatus.textContent = "กำลังขออนุญาต...";
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                ui.previewVideo.srcObject = localStream;
                ui.previewContainer.classList.remove('hidden');
                ui.permissionBtn.classList.add('hidden');
                ui.startChatBtn.classList.remove('hidden');
                ui.homeStatus.textContent = "กล้องพร้อมใช้งานแล้ว!";
            } catch (error) { ui.homeStatus.textContent = "โปรดอนุญาตให้เข้าถึงกล้องและไมโครโฟน"; ui.permissionBtn.disabled = false; }
        };

        ui.startChatBtn.onclick = async () => {
            saveSettings();
            showScreen(ui.chatScreen);
            ui.localVideo.srcObject = localStream;
            await findOrCreateRoom();
        };

        async function findOrCreateRoom() {
            ui.waitingOverlay.style.display = 'flex';
            const roomsRef = collection(db, roomsCollectionPath);
            const partnerCountry = ui.partnerCountrySelect.value;
            const q = query(roomsRef, where('status', '==', 'waiting'));
            const querySnapshot = await getDocs(q);
            const availableRoom = querySnapshot.docs.find(doc => {
                const data = doc.data();
                return data.callerId !== userId && (partnerCountry === 'worldwide' || data.country === partnerCountry);
            });
            if (availableRoom) { await joinRoom(availableRoom.id, availableRoom.data()); } 
            else { await createRoom(); }
        }

        async function createRoom() {
            const roomRef = doc(collection(db, roomsCollectionPath));
            currentRoomId = roomRef.id;
            peerConnection = createPeerConnection();
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            await setDoc(roomRef, { callerId: userId, callerName: ui.userNameInput.value, country: ui.myCountrySelect.value, offer: { type: offer.type, sdp: offer.sdp }, status: 'waiting' });
            listenForAnswer(roomRef);
        }

        async function joinRoom(roomId, roomData) {
            currentRoomId = roomId;
            const roomRef = doc(db, roomsCollectionPath, roomId);
            peerConnection = createPeerConnection();
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            await peerConnection.setRemoteDescription(new RTCSessionDescription(roomData.offer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            await updateDoc(roomRef, { answer: { type: answer.type, sdp: answer.sdp }, calleeId: userId, calleeName: ui.userNameInput.value, status: 'connected' });
            listenForIceCandidates(roomRef);
        }
        
        function createPeerConnection() {
            const pc = new RTCPeerConnection(servers);
            pc.onicecandidate = e => { if (e.candidate && currentRoomId) { addDoc(collection(db, roomsCollectionPath, currentRoomId, 'candidates'), e.candidate.toJSON()); } };
            pc.ontrack = e => { if (e.streams && e.streams[0]) { ui.remoteVideo.srcObject = e.streams[0]; ui.waitingOverlay.style.display = 'none'; } };
            pc.onconnectionstatechange = () => { if (peerConnection && ['disconnected', 'closed', 'failed'].includes(peerConnection.connectionState)) { hangUp(true); } };
            return pc;
        }

        function listenForAnswer(roomRef) {
            roomUnsubscribe = onSnapshot(roomRef, async (snapshot) => {
                const data = snapshot.data();
                if (data && data.answer && peerConnection && !peerConnection.currentRemoteDescription) {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                    listenForIceCandidates(roomRef);
                }
            });
        }
            
        function listenForIceCandidates(roomRef) {
            candidatesUnsubscribe = onSnapshot(collection(db, roomsCollectionPath, currentRoomId, 'candidates'), (snapshot) => {
                snapshot.docChanges().forEach(async (change) => {
                    if (change.type === 'added' && peerConnection.remoteDescription) { await peerConnection.addIceCandidate(new RTCIceCandidate(change.doc.data())); }
                });
            });
        }

        async function hangUp(isAbrupt = false) {
             if (roomUnsubscribe) roomUnsubscribe();
             if (candidatesUnsubscribe) candidatesUnsubscribe();
             if (peerConnection) { peerConnection.close(); peerConnection = null; }
             
             if (currentRoomId) { await deleteDoc(doc(db, roomsCollectionPath, currentRoomId)).catch(console.error); currentRoomId = null; }
            
             if (!isAbrupt) {
                if (localStream) { localStream.getTracks().forEach(track => track.stop()); localStream = null; }
                ui.remoteVideo.srcObject = null;
                ui.previewVideo.srcObject = null;
                ui.previewContainer.classList.add('hidden');
                ui.startChatBtn.classList.add('hidden');
                ui.permissionBtn.classList.remove('hidden');
                ui.permissionBtn.disabled = false;
                showScreen(ui.homeScreen);
             }
        }
        
        ui.stopBtn.onclick = () => hangUp(false);
        ui.nextBtn.onclick = async () => { await hangUp(true); await findOrCreateRoom(); };
        ui.copyUrlBtn.onclick = () => {
            const urlToCopy = "https://" + ui.websiteUrl.textContent;
            navigator.clipboard.writeText(urlToCopy).then(() => {
                ui.copyUrlBtn.textContent = "คัดลอกแล้ว!";
                setTimeout(() => { ui.copyUrlBtn.textContent = "คัดลอก"; }, 2000);
            }).catch(err => {
                console.error('Could not copy text: ', err);
            });
        };
    </script>
</body>
</html>
